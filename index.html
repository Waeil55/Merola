<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üê∂ü§™ Merola's Super-Duper Fun Lab!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bubblegum+Sans&family=Comic+Neue:wght@700;900&display=swap" rel="stylesheet">
    
    <!-- Data & Generator Imports -->
    <script src="readingData.js"></script>
    <script src="lessonData.js"></script>
    <script src="quizGenerators.js"></script>
    <script src="wordPartsData.js"></script>
    <script src="storiesData.js"></script>

    <style>
        :root {
            --bg-color: #F8F4FF;
            --card-bg: #ffffff;
            --text-color: #2D3436;
            --title-color: #9C27B0;
            --instr-color: #673AB7;
            --border-color: #B39DDB;
            --primary-action: #6C5CE7;
            --user-font-size: 22px;
            --header-bg: #673AB7;
            --footer-bg: #F3E5F5;
            --passage-bg: #E1F5FE;
        }

        .dark {
            --bg-color: #1A1A2E;
            --card-bg: #2D3436;
            --text-color: #E1BEE7;
            --title-color: #BB86FC;
            --instr-color: #CFD8DC;
            --border-color: #5E35B1;
            --primary-action: #03DAC6;
            --header-bg: #311B92;
            --footer-bg: #1A1A2E;
            --passage-bg: #37474F;
        }

        body {
            font-family: 'Bubblegum Sans', cursive;
            background-color: var(--bg-color);
            color: var(--text-color);
            background-image: radial-gradient(var(--border-color) 1px, transparent 1px);
            background-size: 30px 30px;
            transition: background-color 0.3s ease, color 0.3s ease;
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" style="font-size:24px"><text y="24">üç≠</text></svg>'), auto;
        }

        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes wiggle { 0% { transform: rotate(0deg); } 25% { transform: rotate(-2deg); } 75% { transform: rotate(2deg); } 100% { transform: rotate(0deg); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .listening { animation: pulse-red 1.5s infinite; background-color: #ef4444 !important; color: white !important; }
        .glass-header { background: var(--header-bg); border-bottom: 6px dashed rgba(255,255,255,0.3); border-radius: 0 0 30px 30px; }
        .card { background-color: var(--card-bg); border: 4px solid var(--border-color); border-radius: 40px; box-shadow: 10px 10px 0px var(--border-color); transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px) rotate(1deg); }
        .q-text { font-size: var(--user-font-size) !important; color: var(--text-color) !important; font-family: 'Comic Neue', cursive; font-weight: 900; }
        .option-btn { font-size: calc(var(--user-font-size) * 0.9) !important; border: 3px solid var(--border-color); border-radius: 25px; background: var(--card-bg); color: var(--text-color); box-shadow: 0 6px 0 var(--border-color); margin-bottom: 8px; }
        .option-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 var(--border-color); }
        .passage-text { font-size: var(--user-font-size) !important; line-height: 1.6 !important; }
        .instruction-text { font-size: calc(var(--user-font-size) * 0.85) !important; line-height: 1.4 !important; }
        .passage-box { background: var(--passage-bg) !important; border: 4px dotted var(--primary-action) !important; border-radius: 30px !important; position: relative; color: var(--text-color); }
        .passage-box::before { content: "üìñ Read This! üìñ"; position: absolute; top: -15px; left: 20px; background: var(--primary-action); color: white; padding: 2px 15px; border-radius: 10px; font-size: 14px; }
        .correct { background: #4CAF50 !important; border-color: #2E7D32 !important; color: white !important; animation: pop 0.3s infinite; }
        .wrong { background: #F44336 !important; border-color: #B71C1C !important; color: white !important; }
        .hub-card { border-radius: 40px; border: 5px solid rgba(255,255,255,0.4); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; }
        .hub-card:hover { transform: scale(1.08) rotate(-2deg); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); }
        
        .lesson-gradient { background: linear-gradient(135deg, #9C27B0, #E91E63); }
        .coin-gradient { background: linear-gradient(135deg, #009688, #00796B); }
        .time-gradient { background: linear-gradient(135deg, #2196F3, #1976D2); }
        .math-gradient { background: linear-gradient(135deg, #FF9800, #F57C00); }
        .shapes-gradient { background: linear-gradient(135deg, #E040FB, #7B1FA2); }
        .grammar-gradient { background: linear-gradient(135deg, #03A9F4, #0288D1); }
        .reading-gradient { background: linear-gradient(135deg, #FF5252, #FF1744); }
        .wordparts-gradient { background: linear-gradient(135deg, #6C5CE7, #a29bfe); }
        .stories-gradient { background: linear-gradient(135deg, #10b981, #059669); }

        .coin-img { display: inline-block; vertical-align: middle; filter: drop-shadow(3px 3px 0px rgba(0,0,0,0.1)); animation: wiggle 2s infinite ease-in-out; margin: 0 2px; }
        .dark .card { background-color: var(--card-bg); }
        .dark .option-btn { background-color: #3d4649; }
        #quiz-footer { background: var(--footer-bg); border-top: 4px solid var(--border-color); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="glass-header sticky top-0 z-50 px-4 py-1 flex flex-col gap-1 shadow-xl">
        <div class="app-shell flex justify-between items-center w-full max-w-5xl mx-auto">
            <div class="flex items-center gap-2">
                <span class="text-2xl animate-bounce">üéà</span>
                <div>
                    <h1 class="text-lg sm:text-xl font-black text-white dark:text-purple-100 tracking-tighter leading-none" style="font-family: 'Comic Neue';">MEROLA'S FUN LAB!</h1>
                    <p class="text-[9px] font-bold text-yellow-300 uppercase leading-none">Learning is a Party! ü•≥</p>
                </div>
            </div>

            <div id="smart-score-box" class="flex items-center bg-yellow-400 text-yellow-900 px-3 py-0.5 rounded-full border-2 border-white shadow-lg animate-pulse transform hover:scale-110 transition-transform cursor-pointer">
                <span class="text-lg mr-1">‚≠ê</span>
                <div class="flex flex-col leading-none">
                    <span class="text-[8px] uppercase font-bold opacity-80">Score</span>
                    <span id="score-val" class="text-base font-black">0</span>
                </div>
            </div>

            <div class="flex items-center gap-1">
                <div class="flex items-center bg-white/20 backdrop-blur rounded-full p-0.5 border border-white/30">
                    <button onclick="adjustFont(-2)" class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center font-black hover:bg-white/30 text-white text-xs">üîç-</button>
                    <button onclick="adjustFont(2)" class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center font-black hover:bg-white/30 ml-0.5 text-white text-xs">üîç+</button>
                </div>
                <button onclick="toggleTheme()" class="w-8 h-8 rounded-full bg-white/20 border-2 border-white/30 flex items-center justify-center text-base shadow-md text-white">
                    <span id="theme-icon">‚ú®</span>
                </button>
                <button onclick="goHome()" class="w-8 h-8 rounded-full bg-white/20 border-2 border-green-300 flex items-center justify-center text-base shadow-md">
                    <span>üè†</span>
                </button>
            </div>
        </div>
        <div id="progress-container" class="hidden w-full max-w-5xl mx-auto mt-0.5 flex gap-2 items-center">
            <div class="flex-grow h-2 bg-black/20 rounded-full overflow-hidden border border-white/30">
                <div id="progress-bar" class="bg-gradient-to-r from-yellow-300 via-orange-400 to-red-400 h-full transition-all duration-700 relative" style="width: 0%">
                    <div class="absolute inset-0 bg-white/20 animate-[wiggle_1s_infinite]"></div>
                </div>
            </div>
            <div id="page-indicator" class="text-[10px] font-bold text-white bg-black/20 px-2 py-0.5 rounded-lg">1/10</div>
        </div>
    </header>

    <main class="flex-grow w-full max-w-5xl mx-auto px-4 py-8 mb-20">
        <div id="main-view"></div>
    </main>

    <footer id="quiz-footer" class="hidden fixed bottom-0 left-0 right-0 py-1 px-4 z-40 shadow-[0_-10px_20_rgba(0,0,0,0.1)]">
        <div class="max-w-xl mx-auto flex gap-4">
            <button onclick="handleBack()" id="prev-btn" class="flex-1 py-2 bg-white dark:bg-gray-800 border-b-4 border-purple-200 text-purple-600 dark:text-purple-300 rounded-3xl font-black text-lg hover:bg-purple-50 transition-all active:scale-95 shadow-lg active:border-b-0 translate-y-0 active:translate-y-1">üîô BACK</button>
            <button onclick="nextPage()" id="next-btn" class="flex-1 py-2 bg-purple-600 border-b-4 border-purple-800 text-white rounded-3xl font-black text-lg hover:bg-purple-500 transition-all active:scale-95 shadow-lg active:border-b-0 translate-y-0 active:translate-y-1 flex items-center justify-center gap-2">NEXT üöÄ</button>
        </div>
    </footer>

    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 px-8 py-4 rounded-full text-white font-black shadow-2xl transition-all duration-300 opacity-0 pointer-events-none z-[60] text-xl border-4 border-white"></div>

    <script>
        // Shared Utilities
        const COIN_URLS = {
            c1: "https://raw.githubusercontent.com/Waeil55/roma/main/1.PNG",
            c5: "https://raw.githubusercontent.com/Waeil55/roma/main/5.PNG",
            c10: "https://raw.githubusercontent.com/Waeil55/roma/main/10.PNG",
            c25: "https://raw.githubusercontent.com/Waeil55/roma/main/25.PNG",
            c100: "https://raw.githubusercontent.com/Waeil55/roma/main/1dollar.PNG"
        };

        const getCoin = (key) => {
            const sizes = { c10: '3.5em', c1: '3.8em', c5: '4.2em', c25: '4.8em', c100: '5.2em' }; 
            return `<img src="${COIN_URLS[key]}" class="coin-img align-middle inline-block mx-1 object-contain max-w-[20vw]" style="height: ${sizes[key]}" alt="${key}">`;
        };

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Global State
        let currentView = 'home';
        let activeData = [];
        let currentPage = 0;
        let userAnswers = {};
        let fontSize = 22;
        let isDarkMode = false;
        let globalScore = 0;
        let recognition = null;
        let isListening = false;
        let currentActivityType = '';

        // Init Voice
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            recognition.onstart = () => { isListening = true; const b = document.getElementById('mic-btn'); if(b) b.classList.add('listening'); };
            recognition.onend = () => { isListening = false; const b = document.getElementById('mic-btn'); if(b) b.classList.remove('listening'); };
            recognition.onresult = (e) => evaluateSpeech(e.results[0][0].transcript);
        }

        // App Core Functions
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark', isDarkMode);
            document.getElementById('theme-icon').innerText = isDarkMode ? '‚òÄÔ∏è' : '‚ú®';
        }

        function goHome() {
            currentView = 'home';
            render();
            window.scrollTo(0, 0);
        }

        function adjustFont(val) {
            fontSize = Math.max(16, Math.min(48, fontSize + val));
            document.documentElement.style.setProperty('--user-font-size', `${fontSize}px`);
        }

        function startSection(type) {
            currentActivityType = type;
            let baseData = [];
            let perPage = 5;

            switch(type) {
                case 'lesson': 
                    activeData = lessonData; 
                    break;
                case 'wordparts':
                    activeData = wordPartsData;
                    break;
                case 'stories':
                    activeData = storiesData.map(s => ({
                        ...s,
                        qs: s.qs.map((q, i) => ({ ...q, q: (i+1).toString() }))
                    }));
                    break;
                case 'reading':
                    perPage = 1;
                    const rawSents = (typeof readingSentences !== 'undefined') ? readingSentences : ["I can read."];
                    activeData = shuffle([...rawSents]).map((s, i) => ({
                        title: `Reading Mastery #${i+1}`,
                        instr: "Read the sentence out loud!",
                        qs: [{ q: s, originalText: s, opts: ["Voice Check"], c: 0, isReading: true }]
                    }));
                    break;
                case 'coin': 
                    baseData = shuffle([...initialCoinData]); 
                    perPage = 2; 
                    break;
                case 'time': 
                    baseData = shuffle(generateTimeData()); 
                    perPage = 8; 
                    break;
                case 'math': 
                    baseData = shuffle(generateMathData()); 
                    perPage = 10; 
                    break;
                case 'shapes': 
                    baseData = shuffle(generateShapesData()); 
                    perPage = 5; 
                    break;
                case 'grammar': 
                    baseData = shuffle(generateGrammarData()); 
                    perPage = 10; 
                    break;
            }

            if (type !== 'lesson' && type !== 'reading' && type !== 'wordparts' && type !== 'stories') {
                activeData = [];
                for (let i = 0; i < baseData.length; i += perPage) {
                    activeData.push({
                        title: `The ${type.toUpperCase()} Quest`,
                        instr: "Solve these puzzles! üèÜ",
                        qs: baseData.slice(i, i + perPage)
                    });
                }
            }

            currentPage = 0;
            userAnswers = {};
            currentView = 'quiz';
            render();
            window.scrollTo(0, 0);
        }

        function handleAnswer(qIdx, oIdx) {
            const key = `${currentPage}-${qIdx}`;
            if (userAnswers[key] !== undefined) return;
            userAnswers[key] = oIdx;
            const isCorrect = oIdx === activeData[currentPage].qs[qIdx].c;
            if (isCorrect) globalScore++;
            
            const toast = document.getElementById('toast');
            const messages = isCorrect ? ["BOOM! üí•", "WIZARD! üßô‚Äç‚ôÇÔ∏è", "GENIUS! üß†", "HOORAY! üéâ"] : ["OOPSIE! üçå", "TRY AGAIN! üßê"];
            toast.innerText = messages[Math.floor(Math.random()*messages.length)];
            toast.style.backgroundColor = isCorrect ? "#4CAF50" : "#F44336";
            toast.style.opacity = "1";
            setTimeout(() => toast.style.opacity = "0", 1200);
            render();
        }

        function render() {
            const main = document.getElementById('main-view');
            const footer = document.getElementById('quiz-footer');
            const progress = document.getElementById('progress-container');
            const scoreVal = document.getElementById('score-val');

            scoreVal.innerText = globalScore;

            if (currentView === 'home') {
                footer.classList.add('hidden');
                progress.classList.add('hidden');
                main.innerHTML = `
                    <div class="text-center py-6">
                        <div class="inline-block bg-white dark:bg-gray-800 p-6 rounded-3xl border-4 border-purple-400 rotate-2 mb-10 shadow-lg">
                             <h2 class="text-3xl lg:text-5xl font-black text-purple-600 dark:text-purple-300">PICK YOUR ADVENTURE! üè∞</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            <div onclick="startSection('lesson')" class="hub-card lesson-gradient p-8 text-white shadow-xl">
                                <div class="text-6xl mb-4">üìñ</div>
                                <h3 class="text-3xl font-black mb-1">Lesson Mastery</h3>
                                <p class="font-bold opacity-80">Full PDF Review</p>
                            </div>
                            <div onclick="startSection('stories')" class="hub-card stories-gradient p-8 text-white shadow-xl">
                                <div class="text-6xl mb-4">üìö</div>
                                <h3 class="text-3xl font-black mb-1">Story Lab</h3>
                                <p class="font-bold opacity-80">Reading Comprehension</p>
                            </div>
                            <div onclick="startSection('wordparts')" class="hub-card wordparts-gradient p-8 text-white shadow-xl">
                                <div class="text-6xl mb-4">üß©</div>
                                <h3 class="text-3xl font-black mb-1">Word Parts</h3>
                                <p class="font-bold opacity-80">Prefix & Suffix Lab</p>
                            </div>
                            <div onclick="startSection('reading')" class="hub-card reading-gradient p-8 text-white shadow-xl">
                                <div class="text-6xl mb-4">üéôÔ∏è</div>
                                <h3 class="text-3xl font-black mb-1">Reading Lab</h3>
                                <p class="font-bold opacity-80">Listen & Speak</p>
                            </div>
                            <div onclick="startSection('coin')" class="hub-card coin-gradient p-8 text-white shadow-xl">
                                <div class="text-6xl mb-4">üí∞</div>
                                <h3 class="text-3xl font-black mb-1">Coin Math Lab</h3>
                                <p class="font-bold opacity-80">Money Counting</p>
                            </div>
                            <div onclick="startSection('time')" class="hub-card time-gradient p-8 text-white shadow-xl">
                                <div class="text-6xl mb-4">‚è∞</div>
                                <h3 class="text-3xl font-black mb-1">Time Lab</h3>
                                <p class="font-bold opacity-80">Read the Clock</p>
                            </div>
                            <div onclick="startSection('math')" class="hub-card math-gradient p-8 text-white shadow-xl">
                                <div class="text-6xl mb-4">‚ûï</div>
                                <h3 class="text-3xl font-black mb-1">Math Lab</h3>
                                <p class="font-bold opacity-80">Math Problems</p>
                            </div>
                            <div onclick="startSection('shapes')" class="hub-card shapes-gradient p-8 text-white shadow-xl">
                                <div class="text-6xl mb-4">üìê</div>
                                <h3 class="text-3xl font-black mb-1">Shapes Lab</h3>
                                <p class="font-bold opacity-80">Geometry</p>
                            </div>
                            <div onclick="startSection('grammar')" class="hub-card grammar-gradient p-8 text-white shadow-xl">
                                <div class="text-6xl mb-4">üñçÔ∏è</div>
                                <h3 class="text-3xl font-black mb-1">Grammar Lab</h3>
                                <p class="font-bold opacity-80">Noun vs Verb</p>
                            </div>
                        </div>
                    </div>`;
            } else if (currentView === 'quiz') {
                footer.classList.remove('hidden');
                progress.classList.remove('hidden');
                const data = activeData[currentPage];
                const prog = ((currentPage + 1) / activeData.length) * 100;
                document.getElementById('progress-bar').style.width = `${prog}%`;
                document.getElementById('page-indicator').innerText = `${currentPage + 1}/${activeData.length}`;

                let passageHtml = data.passage ? `<div class="sticky-passage mb-10"><div class="passage-box p-8 shadow-xl"><p class="font-bold passage-text">${data.passage}</p></div></div>` : '';
                
                let questionsHtml = '';
                if (currentActivityType === 'reading') {
                    const q = data.qs[0];
                    const answered = userAnswers[`${currentPage}-0`] !== undefined;
                    questionsHtml = `
                        <div class="card p-10 text-center">
                            <div class="text-5xl font-black mb-10 text-purple-600 dark:text-purple-300">"${q.q}"</div>
                            <div class="flex flex-col items-center gap-6">
                                <button id="mic-btn" onclick="toggleMic()" ${answered ? 'disabled' : ''} class="w-32 h-32 rounded-full bg-purple-500 text-white flex items-center justify-center text-5xl shadow-xl transition-all active:scale-90 ${answered ? 'opacity-30' : ''}">üé§</button>
                                <button id="speak-btn" onclick="speakSentence('${q.originalText}')" class="px-8 py-4 bg-blue-500 text-white rounded-full font-black text-xl flex items-center gap-2">üîä Listen</button>
                                ${answered ? '<div class="text-5xl animate-bounce">‚úÖ‚≠ê</div>' : ''}
                            </div>
                        </div>`;
                } else {
                    questionsHtml = data.qs.map((q, qIdx) => {
                        const key = `${currentPage}-${qIdx}`;
                        const ans = userAnswers[key];
                        const answered = ans !== undefined;
                        return `
                        <div class="card p-8 mb-6">
                            <div class="font-black mb-6 text-xl q-text">${q.qText ? q.q + " " + q.qText : q.q}</div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                ${q.opts.map((opt, oIdx) => {
                                    let cls = answered ? (oIdx === q.c ? "correct" : (oIdx === ans ? "wrong" : "opacity-30")) : "";
                                    return `<button onclick="handleAnswer(${qIdx}, ${oIdx})" ${answered ? 'disabled' : ''} class="option-btn w-full py-4 px-2 font-bold transition-all ${cls}">${opt}</button>`;
                                }).join('')}
                            </div>
                        </div>`;
                    }).join('');
                }

                main.innerHTML = `
                    <div class="mb-14 text-center">
                        <h2 class="font-black text-4xl mb-4 text-purple-600 dark:text-purple-300">${data.title}</h2>
                        <div class="inline-block bg-purple-200 dark:bg-purple-900 px-6 py-2 rounded-full font-bold text-purple-700 dark:text-purple-200">üí° ${data.instr}</div>
                    </div>
                    <div class="${data.passage ? 'lg:grid lg:grid-cols-2 lg:gap-16' : 'max-w-4xl mx-auto'}">${passageHtml}<div>${questionsHtml}</div></div>`;
            }
        }

        // Helpers for UI state
        function toggleMic() {
            if (!recognition) return;
            isListening ? recognition.stop() : recognition.start();
        }

        function speakSentence(txt) {
            const msg = new SpeechSynthesisUtterance(txt);
            window.speechSynthesis.speak(msg);
        }

        function evaluateSpeech(heard) {
            const target = activeData[currentPage].qs[0].originalText.toLowerCase().replace(/[.,!?;:]/g, "");
            const heardWords = heard.toLowerCase().split(" ");
            const targetWords = target.split(" ");
            let matches = 0;
            targetWords.forEach(w => { if(heardWords.includes(w)) matches++; });
            if (matches / targetWords.length >= 0.6) {
                handleAnswer(0, 0);
            }
        }

        function handleBack() { 
            if (currentPage > 0) {
                currentPage--; 
                render(); 
                window.scrollTo(0, 0);
            } else {
                goHome();
            }
        }

        function nextPage() { 
            if (currentPage < activeData.length - 1) {
                currentPage++; 
                render(); 
                window.scrollTo(0, 0);
            } else {
                finish();
            }
        }

        function finish() {
            currentView = 'results';
            document.getElementById('quiz-footer').classList.add('hidden');
            document.getElementById('progress-container').classList.add('hidden');
            document.getElementById('main-view').innerHTML = `
                <div class="max-w-3xl mx-auto text-center py-12 px-8 bg-white dark:bg-gray-800 rounded-[4rem] shadow-2xl border-8 border-purple-200">
                    <div class="text-9xl mb-8 animate-bounce">üëë</div>
                    <h2 class="text-5xl font-black mb-4 text-purple-600">MISSION COMPLETE!</h2>
                    <div class="text-8xl font-black text-purple-600 mb-12">${globalScore} ‚≠ê</div>
                    <button onclick="goHome()" class="py-6 px-12 bg-purple-600 text-white rounded-[2.5rem] font-black text-2xl shadow-lg active:scale-95 transition-all">BACK TO BASE! üè†</button>
                </div>`;
            window.scrollTo(0, 0);
        }

        window.onload = render;
    </script>
</body> 
</html>

