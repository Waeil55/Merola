<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Shorts</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Shorts">
    
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Waeil55/Merola/main/Y.JPG">
    <link rel="icon" type="image/jpeg" href="https://raw.githubusercontent.com/Waeil55/Merola/main/Y.JPG">
    <meta name="theme-color" content="#000000">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- âœ… EXTERNAL DATA IMPORTS -->
    <script src="lessonData.js"></script>
    <script src="readingData.js"></script>
    <script src="quizGenerators.js"></script>
    <script src="wordPartsData.js"></script>
    <script src="storiesData.js"></script>
    <script src="writingData.js"></script>

    <style>
        :root {
            --yt-black: #000000;
            --yt-white: #ffffff;
            --yt-red: #ff0000;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--yt-black);
            color: var(--yt-white);
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            overscroll-behavior-y: none;
        }

        /* --- SHORTS CONTAINER --- */
        #shorts-container {
            height: 100vh;
            width: 100%;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
            scrollbar-width: none;
            position: relative;
            z-index: 10;
            background: #000;
            padding-bottom: 48px;
        }
        #shorts-container::-webkit-scrollbar { display: none; }

        .short-section {
            height: 100vh;
            height: calc(100vh - 48px); /* Account for bottom nav */
            width: 100%;
            scroll-snap-align: start;
            scroll-snap-stop: always;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #000;
            overflow: hidden;
        }

        /* Video Background Simulation */
        .video-bg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
            opacity: 0.6;
            pointer-events: none;
        }

        /* --- YT HEADER (SAFE AREA FIX) --- */
        .yt-header {
            position: fixed;
            top: 0; left: 0; width: 100%;
            padding: 12px 16px;
            /* ðŸ”¥ Critical Fix for iPhone Notch/Status Bar */
            padding-top: calc(12px + env(safe-area-inset-top)); 
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
            pointer-events: none;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 70%, transparent 100%);
        }
        .yt-header-icons { pointer-events: auto; display: flex; gap: 20px; }

        /* --- YT RIGHT ACTIONS --- */
        .action-bar {
            position: absolute;
            right: 8px;
            bottom: 140px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 20;
            align-items: center;
        }
        .action-item { display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .action-btn {
            width: 48px; height: 48px; border-radius: 50%;
            background: rgba(0,0,0,0.4);
            display: flex; align-items: center; justify-content: center;
            color: white; border: none; cursor: pointer;
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }
        .action-label { font-size: 12px; font-weight: 500; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

        /* --- YT BOTTOM OVERLAY --- */
        .bottom-overlay {
            position: absolute; bottom: 12px; left: 0; width: 100%;
            padding: 16px; padding-right: 60px; z-index: 15;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 10%, transparent 100%);
            display: flex; flex-direction: column; align-items: flex-start;
        }
        .channel-info { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .channel-avatar { width: 36px; height: 36px; background: #333; border-radius: 50%; overflow: hidden; border: 1px solid rgba(255,255,255,0.2); }
        .channel-name { font-weight: 700; font-size: 14px; color: white; }
        .sub-btn { 
            background: white; color: black; padding: 6px 14px; 
            border-radius: 18px; font-size: 12px; font-weight: 600; 
            margin-left: 8px; transition: background 0.2s;
        }
        .sub-btn.subscribed { background: rgba(255,255,255,0.2); color: white; }
        .video-desc { font-size: 14px; color: #f1f1f1; line-height: 1.3; font-weight: 400; max-width: 85%; }
        
        .music-ticker { 
            display: flex; align-items: center; gap: 8px; 
            font-size: 13px; margin-top: 10px; font-weight: 500;
            background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 4px;
        }
        .scrolling-container { width: 150px; overflow: hidden; white-space: nowrap; mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent); }
        .scrolling-text { display: inline-block; padding-left: 100%; animation: scroll 10s linear infinite; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* --- CONTENT AREA --- */
        .content-stage {
            width: 100%; max-width: 500px;
            position: relative; z-index: 5;
            padding: 20px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            margin-bottom: 80px;
        }
        
        .option-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; padding: 16px 20px;
            width: 100%; text-align: left;
            font-weight: 600; font-size: 17px; color: white;
            margin-bottom: 10px; transition: all 0.2s;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .option-card:active { transform: scale(0.98); background: rgba(255, 255, 255, 0.25); }
        .option-card.correct-ans { background: rgba(255, 255, 255, 0.95); color: black; border-color: white; transform: scale(1.02); }
        .option-card.wrong-ans { background: rgba(220, 20, 60, 0.8); border-color: red; }
        
        /* --- BOTTOM NAV BAR --- */
        .yt-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 48px;
            background: #000; border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: white; opacity: 0.6; font-size: 10px; background: none; border: none; }
        .nav-item.active { opacity: 1; }
        .nav-plus-btn { width: 36px; height: 36px; border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); }

        /* --- GAME OVERLAY --- */
        #game-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 200;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        #game-canvas { position: absolute; width: 100%; height: 100%; }
        
        /* ðŸ”¥ Safe Area for Game Close Button */
        .game-close-btn {
            position: absolute;
            top: calc(16px + env(safe-area-inset-top)); /* Safe area fix */
            right: 24px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 999px;
            color: white;
            font-weight: 700;
            backdrop-filter: blur(8px);
            z-index: 210;
        }

        /* --- ANIMATIONS --- */
        @keyframes heart-burst { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }
        .big-heart {
            position: absolute; top: 50%; left: 50%; width: 120px; height: 120px;
            margin-left: -60px; margin-top: -60px; pointer-events: none; z-index: 60;
            fill: white; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
            opacity: 0;
        }
        .big-heart.animate { animation: heart-burst 0.8s ease-out forwards; }
        
        .progress-bar-bottom {
            position: absolute; bottom: 0; left: 0; height: 3px;
            background: red; z-index: 16; width: 0%;
            transition: width 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 0 10px red;
        }
        .confetti { position: absolute; width: 8px; height: 8px; opacity: 0.8; border-radius: 50%; z-index: 20; }
        .q-badge { background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 700; color: #aaa; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .question-text { font-size: 24px; font-weight: 800; text-align: center; margin-bottom: 24px; text-shadow: 0 4px 8px rgba(0,0,0,0.8); line-height: 1.3; }
        .score-pill { background: rgba(255,255,255,0.2); backdrop-filter: blur(4px); padding: 4px 10px; border-radius: 20px; font-weight: bold; font-size: 12px; display: flex; align-items: center; gap: 4px; }
        
        /* ðŸ”¥ Safe Area for Home View */
        #home-view {
            padding-top: calc(16px + env(safe-area-inset-top)) !important;
        }
        
        /* ðŸ”¥ Safe Area for Toast */
        #toast {
            top: calc(80px + env(safe-area-inset-top)) !important;
        }

    </style>
</head>
<body>

    <!-- YT HEADER -->
    <div class="yt-header">
        <div class="font-bold text-lg tracking-tight flex items-center gap-2">
            <span id="streak-counter" class="text-sm bg-red-600 px-2 py-0.5 rounded font-bold hidden">ðŸ”¥ 0</span>
            <div id="star-tracker" class="score-pill hidden"><i data-lucide="star" class="w-3 h-3 fill-yellow-400 text-yellow-400"></i> <span id="star-val">0</span>/3</div>
        </div>
        <div class="yt-header-icons">
            <i data-lucide="search" class="w-6 h-6 text-white"></i>
            <i data-lucide="more-vertical" class="w-6 h-6 text-white"></i>
        </div>
    </div>

    <!-- MAIN APP VIEW -->
    <main id="app-root" class="w-full h-full relative">
        
        <!-- HOME / FEED -->
        <div id="home-view" class="w-full h-full bg-black p-4 overflow-y-auto pb-20">
            <div class="flex items-center gap-3 mb-6">
                <img src="https://raw.githubusercontent.com/Waeil55/Merola/main/Y.JPG" class="w-10 h-10 rounded-full border border-white/20">
                <h1 class="text-xl font-bold">Merola Learning</h1>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div onclick="App.startSession('lesson')" class="aspect-[9/16] bg-gradient-to-br from-purple-900 to-black rounded-xl border border-white/10 relative overflow-hidden group active:scale-95 transition">
                    <div class="absolute inset-0 flex flex-col justify-end p-3 bg-gradient-to-t from-black/90 to-transparent">
                        <span class="text-white font-bold text-sm">Daily Mix</span>
                        <span class="text-xs text-gray-400">1.2M views</span>
                    </div>
                    <div class="absolute top-2 right-2 bg-red-600 px-1.5 py-0.5 rounded text-[10px] font-bold">LIVE</div>
                </div>

                <div onclick="App.startSession('math')" class="aspect-[9/16] bg-gradient-to-br from-blue-900 to-black rounded-xl border border-white/10 relative overflow-hidden active:scale-95 transition">
                    <div class="absolute inset-0 flex flex-col justify-end p-3 bg-gradient-to-t from-black/90 to-transparent">
                        <span class="text-white font-bold text-sm">Math Lab</span>
                        <span class="text-xs text-gray-400">845K views</span>
                    </div>
                </div>

                <div onclick="App.startSession('reading')" class="aspect-[9/16] bg-gradient-to-br from-green-900 to-black rounded-xl border border-white/10 relative overflow-hidden active:scale-95 transition">
                    <div class="absolute inset-0 flex flex-col justify-end p-3 bg-gradient-to-t from-black/90 to-transparent">
                        <span class="text-white font-bold text-sm">Reading</span>
                        <span class="text-xs text-gray-400">2.1M views</span>
                    </div>
                </div>
                
                <div onclick="App.startSession('spelling')" class="aspect-[9/16] bg-gradient-to-br from-yellow-900 to-black rounded-xl border border-white/10 relative overflow-hidden active:scale-95 transition">
                    <div class="absolute inset-0 flex flex-col justify-end p-3 bg-gradient-to-t from-black/90 to-transparent">
                        <span class="text-white font-bold text-sm">Spelling</span>
                        <span class="text-xs text-gray-400">500K views</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- SHORTS SCROLL CONTAINER -->
        <div id="shorts-container" class="hidden">
            <!-- Injected -->
        </div>

    </main>

    <!-- BOTTOM NAV (YT STYLE) -->
    <nav class="yt-nav">
        <button class="nav-item" onclick="App.goHome()">
            <i data-lucide="home" class="w-6 h-6 stroke-[1.5]"></i>
            <span>Home</span>
        </button>
        <button class="nav-item active">
            <img src="https://raw.githubusercontent.com/Waeil55/Merola/main/Y.JPG" class="w-6 h-6 rounded-full border border-white">
            <span>Shorts</span>
        </button>
        <div class="nav-plus-btn">
            <i data-lucide="plus" class="w-6 h-6 text-white stroke-[1.5]"></i>
        </div>
        <button class="nav-item">
            <i data-lucide="play-square" class="w-6 h-6 stroke-[1.5]"></i>
            <span>Subs</span>
        </button>
        <button class="nav-item" id="library-btn">
            <i data-lucide="library" class="w-6 h-6 stroke-[1.5]"></i>
            <span>You</span>
        </button>
    </nav>

    <!-- GAME OVERLAY -->
    <div id="game-overlay">
        <canvas id="game-canvas"></canvas>
        <div class="game-ui absolute top-20 w-full text-center pointer-events-none" style="margin-top: env(safe-area-inset-top);">
            <h2 class="text-4xl font-black text-white italic tracking-tighter mb-2 drop-shadow-lg animate-pulse" id="game-title">BONUS!</h2>
            <div class="game-timer text-7xl font-black text-yellow-400 drop-shadow-xl" id="game-timer-display">15</div>
            <div class="text-white font-bold mt-4 text-xl" id="game-instr">TAP TAP TAP!</div>
        </div>
        <button class="game-close-btn" onclick="GameEngine.stop()">Skip</button>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed left-1/2 -translate-x-1/2 bg-black/80 backdrop-blur-md text-white px-6 py-3 rounded-lg font-medium text-sm shadow-2xl opacity-0 transition-opacity pointer-events-none z-[200] border border-white/10"></div>

    <script>
        /* ------------------------------------------------------------
           VIDEO FX ENGINE (Generates Dynamic Backgrounds)
           ------------------------------------------------------------ */
        const VideoFX = {
            canvases: {},
            
            mount(id, type) {
                const cvs = document.getElementById(`bg-canvas-${id}`);
                if(!cvs) return;
                const ctx = cvs.getContext('2d');
                let w = cvs.width = window.innerWidth;
                let h = cvs.height = window.innerHeight;
                this.canvases[id] = { active: true, type, ctx, w, h, t: 0, elements: [] };
                if(type === 'math') this.initParticles(this.canvases[id], 'numbers');
                else if(type === 'space') this.initParticles(this.canvases[id], 'stars');
                else this.initParticles(this.canvases[id], 'blobs');
                this.loop(id);
            },

            unmount(id) { if(this.canvases[id]) this.canvases[id].active = false; },

            initParticles(scene, style) {
                for(let i=0; i<25; i++) {
                    scene.elements.push({
                        x: Math.random()*scene.w, y: Math.random()*scene.h,
                        vx: (Math.random()-0.5)*1.5, vy: (Math.random()-0.5)*1.5,
                        size: Math.random()*20 + 5,
                        val: style === 'numbers' ? Math.floor(Math.random()*9) : null,
                        color: `hsla(${Math.random()*360}, 70%, 60%, 0.3)`
                    });
                }
            },

            loop(id) {
                const s = this.canvases[id];
                if(!s || !s.active) return;
                s.ctx.clearRect(0,0,s.w,s.h);
                s.t += 0.01;
                const g = s.ctx.createLinearGradient(0,0,0,s.h);
                g.addColorStop(0, `hsl(${Math.sin(s.t)*30 + 240}, 60%, 10%)`);
                g.addColorStop(1, `hsl(${Math.cos(s.t)*30 + 280}, 60%, 5%)`);
                s.ctx.fillStyle = g;
                s.ctx.fillRect(0,0,s.w,s.h);
                s.elements.forEach(e => {
                    e.x += e.vx; e.y += e.vy;
                    if(e.x < 0 || e.x > s.w) e.vx *= -1;
                    if(e.y < 0 || e.y > s.h) e.vy *= -1;
                    s.ctx.fillStyle = e.color;
                    s.ctx.font = `${e.size}px Roboto`;
                    if(e.val !== null) s.ctx.fillText(e.val, e.x, e.y);
                    else { s.ctx.beginPath(); s.ctx.arc(e.x, e.y, e.size/2, 0, Math.PI*2); s.ctx.fill(); }
                });
                requestAnimationFrame(() => this.loop(id));
            }
        };

        /* ------------------------------------------------------------
           AUDIO ENGINE
           ------------------------------------------------------------ */
        const AudioEngine = {
            ctx: null,
            init() {
                if(!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if(this.ctx.state === 'suspended') this.ctx.resume();
            },
            playTone(freq, type, duration, vol = 0.1) {
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            correct() { this.playTone(800, 'sine', 0.1); setTimeout(() => this.playTone(1200, 'sine', 0.3), 100); },
            wrong() { this.playTone(150, 'sawtooth', 0.4); },
            star() { this.playTone(1000, 'triangle', 0.1); setTimeout(() => this.playTone(2000, 'sine', 0.4), 100); },
            pop() { this.playTone(400 + Math.random()*400, 'triangle', 0.05, 0.1); },
            gameStart() { this.playTone(400, 'square', 0.1); setTimeout(() => this.playTone(600, 'square', 0.4), 100); }
        };

        /* ------------------------------------------------------------
           VOICE ENGINE
           ------------------------------------------------------------ */
        const VoiceEngine = {
            recognition: null,
            init() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.lang = 'en-US';
                }
            },
            listen(target, callback) {
                AudioEngine.init(); 
                if (!this.recognition) return App.showToast("Mic not supported");
                this.recognition.onresult = (e) => {
                    const heard = e.results[0][0].transcript.toLowerCase();
                    const cleanTarget = target.toLowerCase().replace(/[.,!]/g, '');
                    const cleanHeard = heard.replace(/[.,!]/g, '');
                    if (cleanHeard.includes(cleanTarget) || cleanTarget.includes(cleanHeard)) callback(true);
                    else { App.showToast(`Heard: "${heard}"`); AudioEngine.wrong(); }
                };
                try { this.recognition.start(); } catch(e) { this.recognition.stop(); setTimeout(() => this.recognition.start(), 200); }
            },
            speak(text) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.rate = 1.0;
                window.speechSynthesis.speak(u);
            }
        };

        /* ------------------------------------------------------------
           MULTI-GAME ENGINE (UPDATED)
           ------------------------------------------------------------ */
        const GameEngine = {
            active: false,
            canvas: document.getElementById('game-canvas'),
            ctx: document.getElementById('game-canvas').getContext('2d'),
            timer: 15,
            interval: null,
            loopId: null,
            entities: [],
            returnIndex: 0,
            mode: 'pop', // 'pop', 'catch', 'whack'
            width: window.innerWidth,
            height: window.innerHeight,
            player: { x: 0, y: 0, w: 60, h: 60 },

            init() {
                window.addEventListener('resize', () => {
                    this.width = window.innerWidth;
                    this.height = window.innerHeight;
                    this.canvas.width = this.width;
                    this.canvas.height = this.height;
                });
                this.canvas.width = this.width;
                this.canvas.height = this.height;
                
                const handleInput = (e) => {
                    e.preventDefault();
                    const x = e.touches ? e.touches[0].clientX : e.clientX;
                    const y = e.touches ? e.touches[0].clientY : e.clientY;
                    this.input(x, y);
                };
                this.canvas.addEventListener('mousedown', handleInput);
                this.canvas.addEventListener('touchstart', handleInput);
                this.canvas.addEventListener('touchmove', handleInput);
                this.canvas.addEventListener('mousemove', (e) => { if(e.buttons === 1) this.input(e.clientX, e.clientY); });
            },

            start(returnIdx) {
                this.active = true;
                this.returnIndex = returnIdx;
                this.timer = 15;
                this.entities = [];
                AudioEngine.gameStart();

                // ðŸŽ² Randomize Game Mode
                const modes = ['pop', 'catch', 'whack'];
                this.mode = modes[Math.floor(Math.random() * modes.length)];

                // Setup specific mode
                if(this.mode === 'catch') {
                    this.player.x = this.width / 2;
                    this.player.y = this.height - 80;
                }

                // Update UI based on Mode
                const titles = { 'pop': 'POP BUBBLES!', 'catch': 'CATCH STARS!', 'whack': 'TAP MONSTERS!' };
                const instrs = { 'pop': 'Tap floating bubbles!', 'catch': 'Drag basket to catch!', 'whack': 'Tap them fast!' };
                document.getElementById('game-title').innerText = titles[this.mode];
                document.getElementById('game-instr').innerText = instrs[this.mode];

                document.getElementById('game-overlay').style.display = 'flex';
                setTimeout(() => document.getElementById('game-overlay').style.opacity = 1, 10);
                
                this.interval = setInterval(() => {
                    this.timer--;
                    document.getElementById('game-timer-display').innerText = this.timer;
                    if(this.timer <= 0) this.stop();
                }, 1000);
                this.loop();
            },

            stop() {
                this.active = false;
                clearInterval(this.interval);
                cancelAnimationFrame(this.loopId);
                document.getElementById('game-overlay').style.opacity = 0;
                setTimeout(() => {
                    document.getElementById('game-overlay').style.display = 'none';
                    App.afterGameReset(this.returnIndex + 1); // ðŸ”¥ Reset logic call
                }, 300);
            },

            input(x, y) {
                if(!this.active) return;
                
                if (this.mode === 'catch') {
                    this.player.x = x; // Update basket position
                } 
                else {
                    // Tap detection for Pop and Whack
                    for (let i = this.entities.length - 1; i >= 0; i--) {
                        const b = this.entities[i];
                        const dist = Math.sqrt((x - b.x)**2 + (y - b.y)**2);
                        if (dist < b.r + 30) {
                            this.entities.splice(i, 1);
                            AudioEngine.pop();
                            App.showToast("Combo +1");
                            return;
                        }
                    }
                }
            },
            
            loop() {
                if(!this.active) return;
                this.ctx.clearRect(0,0, this.width, this.height);
                
                // --- MODE: POP (Bubbles go UP) ---
                if (this.mode === 'pop') {
                    if(Math.random() < 0.1) {
                        this.entities.push({ x: Math.random()*this.width, y: this.height+50, r: 30+Math.random()*20, speed: 4+Math.random()*3, color: `hsl(${Math.random()*360},80%,60%)` });
                    }
                    this.entities.forEach((e,i) => {
                        e.y -= e.speed;
                        this.ctx.fillStyle = e.color; this.ctx.beginPath(); this.ctx.arc(e.x,e.y,e.r,0,Math.PI*2); this.ctx.fill();
                        this.ctx.fillStyle = 'rgba(255,255,255,0.4)'; this.ctx.beginPath(); this.ctx.arc(e.x-e.r/3,e.y-e.r/3,e.r/4,0,Math.PI*2); this.ctx.fill();
                        if(e.y < -50) this.entities.splice(i,1);
                    });
                }
                
                // --- MODE: CATCH (Stars go DOWN) ---
                else if (this.mode === 'catch') {
                    // Draw Player Basket
                    this.ctx.fillStyle = '#fff';
                    this.ctx.beginPath(); this.ctx.arc(this.player.x, this.player.y, 40, 0, Math.PI, false); this.ctx.fill();
                    
                    if(Math.random() < 0.05) {
                        this.entities.push({ x: Math.random()*this.width, y: -50, r: 20, speed: 5+Math.random()*4, color: '#FFD700' }); // Gold stars
                    }
                    this.entities.forEach((e,i) => {
                        e.y += e.speed;
                        this.ctx.fillStyle = e.color; this.ctx.beginPath(); this.ctx.arc(e.x,e.y,e.r,0,Math.PI*2); this.ctx.fill();
                        
                        // Collision with Basket
                        const dist = Math.sqrt((e.x - this.player.x)**2 + (e.y - this.player.y)**2);
                        if(dist < 50) {
                            this.entities.splice(i,1);
                            AudioEngine.correct();
                            App.showToast("Caught!");
                        }
                        else if(e.y > this.height) this.entities.splice(i,1);
                    });
                }

                // --- MODE: WHACK (Moles appear briefly) ---
                else if (this.mode === 'whack') {
                    if(Math.random() < 0.05) {
                        this.entities.push({ x: Math.random()*(this.width-100)+50, y: Math.random()*(this.height-200)+100, r: 40, life: 60, color: '#ff4757' });
                    }
                    this.entities.forEach((e,i) => {
                        e.life--;
                        const scale = e.life > 50 ? (60-e.life)/10 : (e.life < 10 ? e.life/10 : 1);
                        this.ctx.fillStyle = e.color; 
                        this.ctx.beginPath(); this.ctx.arc(e.x,e.y,e.r*scale,0,Math.PI*2); this.ctx.fill();
                        // Eyes
                        this.ctx.fillStyle = '#fff';
                        this.ctx.beginPath(); this.ctx.arc(e.x-10,e.y-5,8*scale,0,Math.PI*2); this.ctx.fill();
                        this.ctx.beginPath(); this.ctx.arc(e.x+10,e.y-5,8*scale,0,Math.PI*2); this.ctx.fill();
                        
                        if(e.life <= 0) this.entities.splice(i,1);
                    });
                }

                this.loopId = requestAnimationFrame(() => this.loop());
            }
        };

        /* ------------------------------------------------------------
           APP LOGIC
           ------------------------------------------------------------ */
        const App = {
            stars: 0,
            streak: 0,
            sessionData: [],
            currentIdx: 0,
            lastTap: 0,

            init() {
                VoiceEngine.init();
                GameEngine.init();
                lucide.createIcons();
                this.updateScoreUI();
                
                const container = document.getElementById('shorts-container');
                container.addEventListener('scroll', () => {
                    clearTimeout(this.scrollTimeout);
                    this.scrollTimeout = setTimeout(() => this.detectActiveShort(), 100);
                });

                container.addEventListener('click', (e) => {
                    const now = new Date().getTime();
                    if((now - this.lastTap < 300) && (now - this.lastTap > 0)) {
                        this.showBigHeart(); AudioEngine.star(); this.handleLike();
                    }
                    this.lastTap = now;
                    AudioEngine.init(); 
                });
            },
            
            showBigHeart() {
                const h = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                h.setAttribute("viewBox", "0 0 24 24");
                h.setAttribute("class", "big-heart animate");
                h.innerHTML = '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>';
                document.body.appendChild(h);
                setTimeout(() => h.remove(), 1000);
            },
            
            handleLike() {
                const label = document.getElementById(`like-count-${this.currentIdx}`);
                if(label && !label.classList.contains('liked')) {
                    label.innerText = parseInt(label.innerText) + 1;
                    label.classList.add('liked', 'text-red-500');
                    document.getElementById(`like-icon-${this.currentIdx}`).style.fill = 'red';
                    document.getElementById(`like-icon-${this.currentIdx}`).style.color = 'red';
                }
            },

            startSession(type) {
                let data = [];
                // Load Data Logic
                if (type === 'reading' && typeof readingSentences !== 'undefined') {
                    data = readingSentences.sort(() => Math.random() - 0.5).slice(0, 15).map(sent => ({ type: 'voice', cat: 'Reading', q: sent }));
                } 
                else if (type === 'spelling' && typeof spellingWords !== 'undefined') {
                    data = spellingWords.sort(() => Math.random() - 0.5).slice(0, 15).map(word => {
                        const opts = [word, 'X', 'Y', 'Z'].map(x => (x === 'X' || x === 'Y' || x === 'Z') ? this.generateDistractor(word) : x).sort(() => Math.random() - 0.5);
                        return { type: 'choice', cat: 'Spelling', q: `Select: ${word}`, opts: opts, ans: opts.indexOf(word) };
                    });
                }
                else if (type === 'lesson' && typeof lessonData !== 'undefined') {
                    lessonData.forEach(topic => { if(topic.qs) { topic.qs.forEach(q => { data.push({ type: 'choice', cat: 'Lesson', q: q.q, opts: q.opts, ans: q.c }); }); } });
                    data = data.sort(() => Math.random() - 0.5).slice(0, 15);
                }

                if (data.length === 0) {
                    for(let i=0; i<15; i++) {
                        const r = Math.random();
                        if(type === 'math' || (type === 'lesson' && r < 0.33)) {
                            const a = Math.floor(Math.random()*12); const b = Math.floor(Math.random()*12);
                            const opts = [a+b, a+b+1, a+b-1, a+b+10].sort(()=>Math.random()-.5);
                            data.push({ type: 'choice', cat: 'Math Lab', q: `${a} + ${b} = ?`, opts, ans: opts.indexOf(a+b) });
                        } else if (type === 'reading' || (type === 'lesson' && r < 0.66)) {
                             const words = ["Elephant", "Sunshine", "Rainbow", "Adventure"];
                             data.push({ type: 'voice', cat: 'Reading', q: words[Math.floor(Math.random()*words.length)] });
                        } else {
                            const words = ["Cat", "Dog", "Bird", "Fish"];
                            const w = words[Math.floor(Math.random()*words.length)];
                            const opts = [...words].sort(()=>Math.random()-.5);
                            data.push({ type: 'choice', cat: 'Spelling', q: `Which is: ${w}?`, opts, ans: opts.indexOf(w) });
                        }
                    }
                }

                this.sessionData = data;
                this.renderShorts();
                document.getElementById('home-view').classList.add('hidden');
                document.getElementById('shorts-container').classList.remove('hidden');
                document.getElementById('streak-counter').classList.remove('hidden');
                document.getElementById('star-tracker').classList.remove('hidden');
            },

            generateDistractor(word) {
                const others = ["Cat", "Ball", "House", "Tree", "Milk", "Star", "Moon"];
                return others[Math.floor(Math.random()*others.length)];
            },

            renderShorts() {
                const container = document.getElementById('shorts-container');
                container.innerHTML = '';
                this.sessionData.forEach((item, idx) => {
                    const section = document.createElement('section');
                    section.className = 'short-section';
                    section.id = `short-${idx}`;
                    let interactHTML = '';
                    if (item.type === 'choice') {
                        interactHTML = `<div class="w-full">`;
                        item.opts.forEach((opt, oIdx) => {
                            interactHTML += `<button onclick="App.handleChoice(${idx}, ${oIdx}, ${item.ans}, this)" class="option-card"><span>${opt}</span></button>`;
                        });
                        interactHTML += `</div>`;
                    } else if (item.type === 'voice') {
                        interactHTML = `<div class="flex flex-col items-center"><button onclick="App.handleVoice(${idx}, '${item.q}')" class="w-24 h-24 rounded-full bg-red-600/20 border-4 border-red-600 flex items-center justify-center mb-6 active:scale-90 transition animate-pulse shadow-[0_0_30px_rgba(255,0,0,0.4)]"><i data-lucide="mic" class="w-10 h-10 text-red-500"></i></button><p class="text-white font-bold bg-black/40 px-4 py-2 rounded-full backdrop-blur-sm">Tap to Speak</p></div>`;
                    }
                    const views = (Math.random() * 800 + 100).toFixed(1) + 'K';
                    section.innerHTML = `
                        <canvas id="bg-canvas-${idx}" class="video-bg"></canvas>
                        <div class="content-stage"><div class="q-badge">${item.cat}</div><div class="question-text">${item.q}</div>${interactHTML}</div>
                        <div class="action-bar">
                            <div class="action-item"><button class="action-btn" onclick="App.handleLike()"><i data-lucide="heart" class="w-7 h-7 stroke-[2]" id="like-icon-${idx}"></i></button><span class="action-label" id="like-count-${idx}">${views}</span></div>
                            <div class="action-item"><button class="action-btn" onclick="App.nextShort(${idx + 1})"><i data-lucide="thumbs-down" class="w-7 h-7 stroke-[2]"></i></button><span class="action-label">Skip</span></div>
                            <div class="action-item"><button class="action-btn" onclick="VoiceEngine.speak('${item.q}')"><i data-lucide="message-circle" class="w-7 h-7 stroke-[2]"></i></button><span class="action-label">Speak</span></div>
                            <div class="action-item"><button class="action-btn"><i data-lucide="share-2" class="w-7 h-7 stroke-[2]"></i></button><span class="action-label">Share</span></div>
                            <div class="action-item"><button class="action-btn bg-white/10 rounded-lg overflow-hidden !p-0"><img src="https://raw.githubusercontent.com/Waeil55/Merola/main/Y.JPG" class="w-full h-full object-cover opacity-80"></button></div>
                        </div>
                        <div class="bottom-overlay">
                            <div class="channel-info"><div class="channel-avatar"><img src="https://raw.githubusercontent.com/Waeil55/Merola/main/Y.JPG" class="w-full h-full object-cover"></div><span class="channel-name">@MerolaLearn</span><button class="sub-btn" onclick="this.classList.add('subscribed'); this.innerText='Subscribed'">Subscribe</button></div>
                            <div class="video-desc">Grade 2 Challenge! #education #learning</div>
                            <div class="music-ticker"><i data-lucide="music-2" class="w-3 h-3"></i><div class="scrolling-container"><div class="scrolling-text">Merola Original Sound - Educational Beat</div></div></div>
                        </div>
                        <div class="progress-bar-bottom" id="prog-${idx}"></div>
                    `;
                    container.appendChild(section);
                    requestAnimationFrame(() => VideoFX.mount(idx, item.cat === 'Math Lab' ? 'math' : 'blobs'));
                });
                lucide.createIcons();
                this.detectActiveShort();
            },

            handleChoice(qIdx, oIdx, cIdx, btn) {
                if(btn.parentElement.classList.contains('answered')) return;
                btn.parentElement.classList.add('answered');
                if (oIdx === cIdx) { btn.classList.add('correct-ans'); this.success(qIdx); } 
                else { btn.classList.add('wrong-ans'); btn.parentElement.children[cIdx].classList.add('correct-ans'); AudioEngine.wrong(); this.streak = 0; this.updateScoreUI(); setTimeout(() => this.nextShort(qIdx + 1), 2000); }
                document.getElementById(`prog-${qIdx}`).style.width = "100%";
            },

            handleVoice(qIdx, target) {
                VoiceEngine.listen(target, (success) => { if(success) { this.success(qIdx); document.getElementById(`prog-${qIdx}`).style.width = "100%"; }});
            },

            success(qIdx) {
                AudioEngine.correct();
                this.stars++;
                this.streak++;
                this.showBigHeart();
                this.handleLike(); 
                this.updateScoreUI();
                
                // Confetti
                for(let i=0; i<30; i++) {
                    const c = document.createElement('div');
                    c.className = 'confetti';
                    c.style.background = ['#f00', '#fff', '#00f'][Math.floor(Math.random()*3)];
                    c.style.left = (Math.random()*100) + '%';
                    c.style.top = '-10px';
                    document.getElementById(`short-${qIdx}`).appendChild(c);
                    c.style.transition = `top ${1+Math.random()}s linear`;
                    setTimeout(()=> c.style.top = '100vh', 10);
                }

                if (this.stars >= 3) {
                    setTimeout(() => GameEngine.start(qIdx), 1500);
                } else {
                    setTimeout(() => this.nextShort(qIdx + 1), 1500);
                }
            },

            // ðŸ”¥ Reset Function Called After Game
            afterGameReset(nextIdx) {
                this.stars = 0; // Reset Score
                this.updateScoreUI();
                this.nextShort(nextIdx); // Continue learning flow
            },

            updateScoreUI() {
                document.getElementById('streak-counter').innerText = `ðŸ”¥ ${this.streak}`;
                document.getElementById('star-val').innerText = this.stars;
            },

            detectActiveShort() {
                const shorts = document.querySelectorAll('.short-section');
                shorts.forEach((s, i) => {
                    const rect = s.getBoundingClientRect();
                    if(rect.top > -100 && rect.top < 100) { this.currentIdx = i; }
                });
            },

            nextShort(targetIdx) {
                const idxToFind = (typeof targetIdx === 'number') ? targetIdx : (this.currentIdx + 1);
                const next = document.getElementById(`short-${idxToFind}`);
                if (next) { next.scrollIntoView({ behavior: 'smooth' }); this.currentIdx = idxToFind; } 
                else { this.showToast("You finished the set!"); setTimeout(() => this.goHome(), 2000); }
            },

            goHome() {
                document.getElementById('shorts-container').classList.add('hidden');
                document.getElementById('home-view').classList.remove('hidden');
                document.getElementById('streak-counter').classList.add('hidden');
                document.getElementById('star-tracker').classList.add('hidden');
            },

            showToast(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.style.opacity = 1;
                setTimeout(() => t.style.opacity = 0, 2000);
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>


