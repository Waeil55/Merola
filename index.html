<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Marley Shorts</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Marley">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Waeil55/Marley/main/Y.JPG">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --yt-red: #ff0000;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #000;
            color: white;
            margin: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            overscroll-behavior-y: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .shorts-wrapper {
            height: 100vh;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .shorts-wrapper::-webkit-scrollbar { display: none; }

        .short-card {
            height: 100vh;
            width: 100vw;
            scroll-snap-align: start;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        .yt-header {
            position: fixed;
            top: var(--safe-top);
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            z-index: 1000;
            pointer-events: none;
        }
        .header-left { display: flex; align-items: center; gap: 8px; pointer-events: auto; }
        .shorts-title { font-size: 22px; font-weight: 900; letter-spacing: -1px; }
        .header-right { display: flex; items-center; gap: 20px; pointer-events: auto; }

        .prog-header {
            position: fixed;
            top: calc(var(--safe-top) + 2px);
            left: 0;
            width: 100%;
            display: flex;
            gap: 4px;
            padding: 0 10px;
            z-index: 1001;
            pointer-events: none;
        }
        .seg { flex: 1; height: 2px; background: rgba(255,255,255,0.2); border-radius: 1px; }
        .fill { height: 100%; width: 0%; background: #fff; transition: width 0.3s; }

        .sidebar {
            position: absolute;
            right: 8px;
            bottom: calc(85px + var(--safe-bottom));
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            z-index: 100;
            pointer-events: auto;
        }
        .sidebar-btn { display: flex; flex-direction: column; align-items: center; gap: 2px; text-align: center; cursor: pointer; }
        .icon-box { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .label { font-size: 12px; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

        .profile-wrap {
            width: 44px; height: 44px; border-radius: 50%; border: 2px solid #fff;
            position: relative; margin-bottom: 8px;
        }
        .profile-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .plus-badge {
            position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
            background: var(--yt-red); width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 900; border: 2px solid #000;
        }

        .bottom-ui {
            position: absolute; bottom: calc(15px + var(--safe-bottom));
            left: 12px; right: 80px; z-index: 100; pointer-events: none;
        }
        .handle-row { font-weight: 700; font-size: 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; pointer-events: auto; }
        .sub-btn { background: #fff; color: #000; padding: 6px 12px; border-radius: 100px; font-size: 12px; font-weight: 700; cursor: pointer; }
        .caption { font-size: 14px; line-height: 1.4; margin-bottom: 12px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); pointer-events: auto; }

        .video-fx { position: absolute; inset: 0; background: radial-gradient(circle at 50% 50%, var(--color, #6366f1) 0%, #000 100%); opacity: 0.6; z-index: 0; }
        .main-canvas { position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; width: 100%; padding: 0 30px; pointer-events: auto; }
        .hero-visual { font-size: 10rem; filter: drop-shadow(0 20px 40px rgba(0,0,0,0.8)); font-family: 'Quicksand', sans-serif; margin-bottom: 30px; }
        
        .grid-opts { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 340px; }
        .opt-bubble { background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(25px); border: 1.5px solid rgba(255, 255, 255, 0.2); border-radius: 16px; padding: 18px 5px; font-weight: 700; font-size: 1.2rem; color: white; cursor: pointer; }
        .opt-bubble.correct { background: #22c55e; border-color: #4ade80; }
        .opt-bubble.wrong { background: #ef4444; border-color: #f87171; }

        .mic-btn { width: 85px; height: 85px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid #fff; margin-top: 10px; transition: all 0.2s; cursor: pointer; }
        .mic-btn.active { background: var(--yt-red); box-shadow: 0 0 35px var(--yt-red); animation: mic-pulse 1s infinite; }
        @keyframes mic-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        .game-obj { position: absolute; z-index: 200; font-size: 7.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 180px; height: 180px; will-change: transform, left, top; transition: left 0.3s ease-out, top 0.3s ease-out; }
        .pop-bubble { border-radius: 50%; background: rgba(255,255,255,0.4); border: 4px solid rgba(255,255,255,0.5); backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center; font-size: 3.5rem; position: absolute; animation: fly-up var(--d) linear forwards; cursor: pointer; }
        @keyframes fly-up { from { transform: translateY(110vh); } to { transform: translateY(-20vh); } }

        .yt-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #000; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; align-items: center; z-index: 2000; padding-bottom: var(--safe-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-label { font-size: 10px; font-weight: 500; }

        .confetti { position: absolute; pointer-events: none; z-index: 1000; animation: pop 1s ease-out forwards; }
        @keyframes pop { 0% { transform: translate(0,0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) rotate(360deg) scale(0); opacity: 0; } }
    </style>
</head>
<body>

    <div class="prog-header" id="prog-header"></div>
    <div class="yt-header">
        <div class="header-left"><span class="shorts-title">Shorts</span></div>
        <div class="header-right">
            <i data-lucide="search" class="w-6 h-6"></i>
            <i data-lucide="camera" class="w-6 h-6"></i>
            <i data-lucide="more-vertical" class="w-6 h-6"></i>
        </div>
    </div>

    <div id="shorts-feed" class="shorts-wrapper"></div>

    <nav class="yt-nav">
        <div class="nav-item"><i data-lucide="home" class="w-6 h-6"></i><span class="nav-label">Home</span></div>
        <div class="nav-item"><i data-lucide="compass" class="w-6 h-6 text-white"></i><span class="nav-label">Shorts</span></div>
        <div class="w-10 h-10 border border-white/40 rounded-full flex items-center justify-center"><i data-lucide="plus" class="w-7 h-7"></i></div>
        <div class="nav-item opacity-40"><i data-lucide="play-square" class="w-6 h-6"></i><span class="nav-label">Subs</span></div>
        <div class="nav-item opacity-40"><i data-lucide="user" class="w-6 h-6"></i><span class="nav-label">You</span></div>
    </nav>

    <script>
        const apiKey = "";
        const ANIMALS = {"üê∂":"Dog","üê±":"Cat","üêª":"Bear","ü¶Å":"Lion","üêÆ":"Cow","üê∑":"Pig","üê∏":"Frog","üêî":"Hen","üê¶":"Bird","ü¶Ü":"Duck","ü¶á":"Bat","üê∫":"Wolf","üêü":"Fish","üêê":"Goat"};
        const FOOD = {"üçê":"Pear","ü•ù":"Kiwi","üåΩ":"Corn","ü•©":"Meat","üç∞":"Cake","ü•ß":"Pie","ü•ö":"Egg","ü•£":"Soup","üçö":"Rice","ü•õ":"Milk","üåÆ":"Taco","ü•Ø":"Bun"};
        const NUMS = ["Zero","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen","Twenty"];
        const GAMES = {"üçê":"Pear","‚öΩ":"Ball","‚≠ê":"Star","üßÅ":"Cake","ü•ö":"Egg","üåΩ":"Corn"};

        let POOL = [];
        let state = {
            score: parseInt(localStorage.getItem('m_v17_stars') || 0),
            idx: -1,
            maxIdxReached: 0,
            canAns: true,
            timers: [],
            voices: [],
            rec: null,
            currentAudio: null,
            audioRequestId: 0
        };

        function buildPool() {
            let temp = [];
            Object.keys(ANIMALS).forEach(e => temp.push({e, n: ANIMALS[e], c: "#6366f1", type: "spell"}));
            Object.keys(FOOD).forEach(e => temp.push({e, n: FOOD[e], c: "#ef4444", type: "spell"}));
            for(let i=1; i<=20; i++) temp.push({e:i, n: NUMS[i], c: "#10b981", type: "pick"});
            "ABCD".split('').forEach(l => temp.push({e:l, n: l, c: "#f59e0b", type: "pick"}));
            
            // Addition tasks (1 to 5)
            for(let i=1; i<=5; i++) {
                for(let j=0; j<=5; j++) {
                    if(i+j <= 10) temp.push({e:`${i} + ${j}`, n: (i+j).toString(), c: "#8b5cf6", type: "add"});
                }
            }

            temp.sort(() => Math.random() - 0.5);
            while(POOL.length < 400) POOL.push({...temp[POOL.length % temp.length]});
        }

        async function speak(text, requestId) {
            stopAllSounds();
            if (requestId !== state.audioRequestId) return;
            const u = new SpeechSynthesisUtterance(text);
            const v = state.voices.find(v => (v.name.includes("Google") || v.name.includes("Samantha") || v.name.includes("Natural")) && v.lang.startsWith("en"));
            if(v) u.voice = v;
            u.pitch = 1.1; u.rate = 1.0;
            window.speechSynthesis.speak(u);
        }

        function stopAllSounds() {
            window.speechSynthesis.cancel();
            if (state.currentAudio) {
                state.currentAudio.pause();
                state.currentAudio.src = "";
                state.currentAudio = null;
            }
        }

        function init() {
            buildPool();
            const feed = document.getElementById('shorts-feed');
            const prog = document.getElementById('prog-header');
            POOL.forEach((item, i) => {
                const card = document.createElement('div');
                card.className = 'short-card'; card.id = `card-${i}`;
                feed.appendChild(card);
                prog.innerHTML += `<div class="seg"><div id="fill-${i}" class="fill"></div></div>`;
            });
            lucide.createIcons();
            const sv = () => { state.voices = window.speechSynthesis.getVoices(); };
            sv(); 
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = sv;
            }
            if ('webkitSpeechRecognition' in window) {
                state.rec = new webkitSpeechRecognition();
                state.rec.continuous = false;
                state.rec.interimResults = false; 
                state.rec.lang = 'en-US';
            }
            feed.addEventListener('scroll', handleScroll, {passive: true});
            handleScroll();
        }

        function renderCard(i) {
            const card = document.getElementById(`card-${i}`);
            if (card.innerHTML !== '') return;
            const item = POOL[i];
            
            if (i > 0 && i % 4 === 3) {
                const games = ['catch', 'pop', 'tap'];
                const type = games[i % games.length];
                const emojis = Object.keys(GAMES);
                const emoji = emojis[i % emojis.length];
                card.dataset.type = "game"; card.dataset.game = type; card.dataset.emoji = emoji;
                card.innerHTML = `<div class="video-fx" style="--color: #ff0055"></div><div class="main-canvas"><h2 class="text-4xl font-black italic mb-2 tracking-tighter">GAME TIME</h2><div id="game-zone-${i}" class="absolute inset-0 w-full h-full pointer-events-none"></div></div>${getSidebar()}${getBottom(`Catch the ${GAMES[emoji]}!`)}`;
            } else if (item.type === "spell" && i % 2 === 0) {
                card.dataset.type = "spell";
                card.innerHTML = `<div class="video-fx" style="--color: ${item.c}"></div><div class="main-canvas"><div class="hero-visual">${item.e}</div><h3 class="text-2xl font-bold mb-4 uppercase text-center">Say it!</h3><button id="mic-${i}" onclick="startMic(${i}, '${item.n}')" class="mic-btn"><i data-lucide="mic" class="w-10 h-10 text-white"></i></button></div>${getSidebar()}${getBottom(`Say ${item.n}!`)}`;
            } else if (item.type === "add") {
                let opts = [item.n];
                while(opts.length < 4) {
                    let r = Math.floor(Math.random() * 11).toString();
                    if(!opts.includes(r)) opts.push(r);
                }
                opts.sort(() => Math.random() - 0.5);
                card.innerHTML = `<div class="video-fx" style="--color: ${item.c}"></div><div class="main-canvas"><div class="hero-visual">${item.e}</div><div class="grid-opts">${opts.map(o => `<button onclick="checkPick(${i}, '${o}', '${item.n}', this)" class="opt-bubble">${o}</button>`).join('')}</div></div>${getSidebar()}${getBottom(`What is ${item.e}?`)}`;
            } else {
                let opts = [item];
                while(opts.length < 4) {
                    let r = POOL[Math.floor(Math.random()*POOL.length)];
                    if(!opts.find(o => o.n === r.n)) opts.push(r);
                }
                opts.sort(() => Math.random() - 0.5);
                card.innerHTML = `<div class="video-fx" style="--color: ${item.c}"></div><div class="main-canvas"><div class="hero-visual">${item.e}</div><div class="grid-opts">${opts.map(o => `<button onclick="checkPick(${i}, '${o.n}', '${item.n}', this)" class="opt-bubble">${o.n}</button>`).join('')}</div></div>${getSidebar()}${getBottom(`Find ${item.n}!`)}`;
            }
            lucide.createIcons();
        }

        function getSidebar() {
            return `<div class="sidebar"><div class="profile-wrap"><img src="https://raw.githubusercontent.com/Waeil55/Marley/main/Y.JPG" class="profile-img"><div class="plus-badge">+</div></div><div class="sidebar-btn" onclick="celebrate(innerWidth/2, innerHeight/2)"><div class="icon-box"><i data-lucide="thumbs-up" class="w-7 h-7 fill-white text-white"></i></div><span class="label">12K</span></div><div class="sidebar-btn"><div class="icon-box"><i data-lucide="message-square" class="w-7 h-7 fill-white text-white"></i></div><span class="label">421</span></div><div class="sidebar-btn"><div class="icon-box"><i data-lucide="share-2" class="w-7 h-7 fill-white text-white"></i></div><span class="label">Share</span></div><div class="w-8 h-8 rounded border-2 border-white overflow-hidden animate-[spin_4s_linear_infinite]"><img src="https://raw.githubusercontent.com/Waeil55/Marley/main/Y.JPG" class="w-full h-full object-cover"></div></div>`;
        }

        function getBottom(desc) {
            return `<div class="bottom-ui"><div class="handle-row"><div class="w-8 h-8 rounded-full overflow-hidden border border-white/20"><img src="https://raw.githubusercontent.com/Waeil55/Marley/main/Y.JPG" class="w-full h-full object-cover"></div>@marley_world <span class="subscribe-btn">Subscribe</span></div><div class="caption">${desc}</div></div>`;
        }

        function handleScroll() {
            const feed = document.getElementById('shorts-feed');
            const currentTop = feed.scrollTop;
            const idx = Math.round(currentTop / window.innerHeight);

            // Block scrolling back down
            if (idx < state.idx) {
                feed.scrollTo({top: state.idx * window.innerHeight, behavior: 'auto'});
                return;
            }

            if(idx !== state.idx) {
                stopAllSounds();
                state.audioRequestId++;
                const currentReqId = state.audioRequestId;

                state.timers.forEach(t => clearInterval(t)); state.timers = [];
                state.idx = idx; state.canAns = true;
                
                document.querySelectorAll('.short-card').forEach((c, i) => {
                    if (Math.abs(i - idx) > 1) c.innerHTML = '';
                    else renderCard(i);
                });

                document.querySelectorAll('.fill').forEach((f, i) => f.style.width = i <= idx ? '100%' : '0');
                const card = document.getElementById(`card-${idx}`);
                
                if(card && card.dataset.type === "game") startGames(idx, card.dataset.game, card.dataset.emoji);
                
                const item = POOL[idx]; let msg = "";
                if(card && card.dataset.type === "game") msg = `Catch the ${GAMES[card.dataset.emoji]}!`;
                else if(card && card.dataset.type === "spell") msg = `Can you say ${item.n}?`;
                else if(item.type === "add") msg = `What is ${item.e}?`;
                else msg = `Find ${item.n}!`;
                
                speak(msg, currentReqId);
            }
        }

        function startGames(idx, type, emoji) {
            const zone = document.getElementById(`game-zone-${idx}`);
            if(!zone) return; zone.innerHTML = ''; zone.style.pointerEvents = 'auto';
            if(type === 'catch') {
                const t = document.createElement('div'); t.className = 'game-obj'; t.innerHTML = emoji;
                t.style.left = '50%'; t.style.top = '50%'; t.onpointerdown = () => winGame(idx, t);
                zone.appendChild(t); const move = () => {
                    t.style.left = (Math.random() * (innerWidth - 180) + 10) + 'px';
                    t.style.top = (Math.random() * (innerHeight * 0.45) + (innerHeight * 0.25)) + 'px';
                };
                state.timers.push(setInterval(move, 400)); move();
            } else if(type === 'pop') {
                const gen = () => {
                    if(zone.children.length > 8) return;
                    const b = document.createElement('div'); b.className = 'pop-bubble'; b.innerHTML = emoji;
                    b.style.left = (Math.random() * 80 + 5) + '%'; b.style.setProperty('--d', (2 + Math.random()) + 's');
                    b.onpointerdown = () => { b.style.transform='scale(0)'; setTimeout(()=>b.remove(),100); if(Math.random()>0.8) winGame(idx, null); };
                    zone.appendChild(b); setTimeout(() => b.remove(), 3500);
                };
                state.timers.push(setInterval(gen, 300));
            } else if(type === 'tap') {
                const t = document.createElement('div'); t.className = 'game-obj vibrate'; t.innerHTML = emoji;
                t.style.left = '50%'; t.style.top = '45%'; t.style.transform = 'translate(-50%, -50%) scale(1.8)';
                let h = 0; t.onpointerdown = (e) => { 
                    h++; t.style.transform = `translate(-50%, -50%) scale(${1.8 + h * 0.5})`;
                    celebrate(e.clientX, e.clientY); if(h >= 6) winGame(idx, t);
                };
                zone.appendChild(t);
            }
        }

        function winGame(idx, el) {
            if(el) { el.style.transform = "scale(20) rotate(720deg)"; el.style.opacity = "0"; el.style.pointerEvents = "none"; }
            state.timers.forEach(t => clearInterval(t)); celebrate(innerWidth/2, innerHeight/2);
            speak("Wow! Superstar!", state.audioRequestId);
            setTimeout(() => document.getElementById('shorts-feed').scrollBy({top: window.innerHeight, behavior: 'smooth'}), 1200);
        }

        function checkPick(i, pick, match, btn) {
            if(!state.canAns) return;
            if(pick === match) {
                state.canAns = false; btn.classList.add('correct'); celebrate(innerWidth/2, innerHeight/2);
                speak(`${match} is right!`, state.audioRequestId);
                setTimeout(() => document.getElementById('shorts-feed').scrollBy({top: window.innerHeight, behavior: 'smooth'}), 1500);
            } else { speak("Try again!", state.audioRequestId); }
        }

        function startMic(idx, target) {
            if (!state.rec) return;
            const btn = document.getElementById(`mic-${idx}`); btn.classList.add('active');
            
            // Immediate start
            state.rec.start();
            
            state.rec.onresult = (e) => {
                const heard = e.results[0][0].transcript.toLowerCase(); 
                btn.classList.remove('active');
                state.rec.stop(); // Stop immediately after result to reduce background noise capture
                
                if (heard.includes(target.toLowerCase())) {
                    celebrate(innerWidth/2, innerHeight/2); 
                    speak("Perfect!", state.audioRequestId);
                    setTimeout(() => document.getElementById('shorts-feed').scrollBy({top: window.innerHeight, behavior: 'smooth'}), 1200);
                } else { 
                    speak(`Try again! Say ${target}`, state.audioRequestId); 
                }
            };
            
            state.rec.onerror = () => {
                btn.classList.remove('active');
                state.rec.stop();
            };
            
            // Automatic timeout if no sound to prevent background noise infinite listening
            setTimeout(() => {
                if(btn.classList.contains('active')) {
                    btn.classList.remove('active');
                    state.rec.stop();
                }
            }, 3000);
        }

        function celebrate(x, y) {
            const ems = ['‚≠ê','‚ú®','üéà','üéä','‚ù§Ô∏è','üî•'];
            for(let i=0; i<12; i++) {
                const c = document.createElement('div'); c.className = 'confetti';
                c.innerHTML = ems[Math.floor(Math.random()*ems.length)];
                c.style.left = x + 'px'; c.style.top = y + 'px';
                c.style.setProperty('--tx', (Math.random()-0.5) * 600 + 'px');
                c.style.setProperty('--ty', (Math.random()-0.5) * 600 + 'px');
                document.body.appendChild(c); setTimeout(() => c.remove(), 1200);
            }
        }
        window.onload = init;
    </script>
</body>
</html>

