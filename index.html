<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üê∂ü§™ Merola's Super-Duper Fun Lab!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bubblegum+Sans&family=Comic+Neue:wght@700;900&display=swap" rel="stylesheet">
    
    <!-- Data Imports -->
    <script src="readingData.js"></script>
    <script src="lessonData.js"></script>
    <script src="quizGenerators.js"></script>
    <script src="wordPartsData.js"></script>
    <script src="storiesData.js"></script>
    <script src="writingData.js"></script>

    <style>
        :root {
            --bg-color: #F8F4FF;
            --card-bg: #ffffff;
            --text-color: #2D3436;
            --title-color: #9C27B0;
            --instr-color: #673AB7;
            --border-color: #B39DDB;
            --primary-action: #6C5CE7;
            --user-font-size: 22px;
            --header-bg: #673AB7;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Bubblegum Sans', cursive;
            background-image: radial-gradient(var(--border-color) 1px, transparent 1px);
            background-size: 30px 30px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dark {
            --bg-color: #1A1A2E;
            --card-bg: #2D3436;
            --text-color: #E1BEE7;
            --title-color: #BB86FC;
            --border-color: #5E35B1;
            --header-bg: #311B92;
        }

        /* Dynamic Font Size Classes */
        .q-text { font-size: var(--user-font-size) !important; font-family: 'Comic Neue', cursive; font-weight: 900; }
        .instr-text { font-size: calc(var(--user-font-size) * 0.7) !important; line-height: 1.2; font-weight: bold; }
        .option-btn { font-size: calc(var(--user-font-size) * 0.9) !important; border-radius: 25px; background: var(--card-bg); box-shadow: 0 6px 0 var(--border-color); border: 2px solid var(--border-color); color: var(--text-color); }
        .option-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 var(--border-color); }
        
        /* Fixed: Linked passage-text to user-font-size */
        .passage-text { 
            font-size: var(--user-font-size) !important; 
            line-height: 1.6; 
            font-weight: 900; 
            font-family: 'Comic Neue', cursive;
        }

        /* Advanced UI Animations */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.6); opacity: 0; }
        }
        @keyframes wave {
            0%, 100% { height: 10px; }
            50% { height: 45px; }
        }
        .listening-ring {
            position: absolute;
            width: 110px; height: 110px;
            border-radius: 50%;
            border: 5px solid #ef4444;
            animation: pulse-ring 1.5s infinite;
        }
        .wave-bar {
            width: 7px; background: #6C5CE7; border-radius: 4px;
            animation: wave 1s infinite ease-in-out;
        }

        .card { background-color: var(--card-bg); border: 4px solid var(--border-color); border-radius: 40px; box-shadow: 8px 8px 0px var(--border-color); }
        .sticky-passage-wrapper { position: sticky; top: 85px; z-index: 30; padding-bottom: 1rem; }
        .passage-box { background: #E1F5FE !important; border: 4px dotted var(--primary-action) !important; border-radius: 30px !important; }

        .hub-card { border-radius: 40px; border: 5px solid rgba(255,255,255,0.4); cursor: pointer; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .hub-card:hover { transform: scale(1.05) rotate(-1deg); }

        .correct { background: #4CAF50 !important; color: white !important; border-color: #2E7D32 !important; }
        .wrong { background: #F44336 !important; color: white !important; border-color: #B71C1C !important; }

        .lesson-gradient { background: linear-gradient(135deg, #9C27B0, #E91E63); }
        .reading-gradient { background: linear-gradient(135deg, #FF5252, #FF1744); }
        .writing-gradient { background: linear-gradient(135deg, #fdcb6e, #e17055); }
        .stories-gradient { background: linear-gradient(135deg, #10b981, #059669); }
        .math-gradient { background: linear-gradient(135deg, #FF9800, #F57C00); }
        .coin-gradient { background: linear-gradient(135deg, #009688, #00796B); }
        .time-gradient { background: linear-gradient(135deg, #2196F3, #1976D2); }
        .shapes-gradient { background: linear-gradient(135deg, #E040FB, #7B1FA2); }
        .grammar-gradient { background: linear-gradient(135deg, #03A9F4, #0288D1); }
        .wordparts-gradient { background: linear-gradient(135deg, #6C5CE7, #a29bfe); }

        .glass-header { background: var(--header-bg); border-bottom: 5px dashed rgba(255,255,255,0.3); border-radius: 0 0 25px 25px; }

        .spelling-input {
            width: 100%;
            border: 4px solid var(--border-color);
            border-radius: 20px;
            padding: 15px;
            font-family: 'Comic Neue', cursive;
            font-weight: 700;
            outline: none;
            background: #fdfdfd;
            text-align: center;
        }
        .spelling-input:focus { border-color: var(--primary-action); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="glass-header sticky top-0 z-50 px-4 py-2 flex flex-col gap-1 shadow-xl text-white">
        <div class="flex justify-between items-center max-w-5xl mx-auto w-full">
            <div class="flex items-center gap-2">
                <span class="text-2xl sm:text-3xl animate-bounce">üç¶</span>
                <div>
                    <h1 class="text-base sm:text-xl font-black font-['Comic_Neue'] tracking-tight leading-none uppercase">Merola's Lab</h1>
                    <p class="text-[8px] sm:text-[10px] uppercase font-bold text-yellow-300 leading-none mt-0.5">Grade 2 Discovery!</p>
                </div>
            </div>

            <div class="flex items-center gap-1.5 sm:gap-4">
                <div class="flex items-center bg-white/20 backdrop-blur rounded-full p-0.5 sm:p-1 border border-white/30">
                    <button onclick="adjustFont(-2)" class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-white/10 flex items-center justify-center font-black hover:bg-white/30 text-white text-[10px] sm:text-xs">A-</button>
                    <button onclick="adjustFont(2)" class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-white/10 flex items-center justify-center font-black hover:bg-white/30 ml-0.5 sm:ml-1 text-white text-[10px] sm:text-xs">A+</button>
                </div>

                <button onclick="toggleTheme()" class="w-8 h-8 sm:w-10 sm:h-10 bg-white/20 rounded-full flex items-center justify-center text-sm sm:text-lg border border-white/30">
                    <span id="theme-icon">‚ú®</span>
                </button>

                <div class="bg-yellow-400 text-yellow-900 px-2.5 sm:px-5 py-1 sm:py-1.5 rounded-full font-black border-2 border-white shadow-md">
                    ‚≠ê <span id="score-val" class="text-sm sm:text-lg">0</span>
                </div>
                
                <button onclick="goHome()" class="w-8 h-8 sm:w-10 sm:h-10 bg-white/20 rounded-full flex items-center justify-center text-lg sm:text-xl border border-white/30">üè†</button>
            </div>
        </div>
        
        <div id="progress-container" class="hidden max-w-5xl mx-auto w-full mt-1 sm:mt-2">
            <div class="h-2.5 sm:h-3.5 bg-black/20 rounded-full overflow-hidden border border-white/20">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-yellow-300 to-orange-400 transition-all duration-700 relative"></div>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-5xl mx-auto px-4 py-6 sm:py-10 w-full mb-24">
        <div id="main-view"></div>
    </main>

    <footer id="quiz-footer" class="hidden fixed bottom-0 left-0 right-0 py-4 px-4 sm:px-6 z-40 bg-white/90 dark:bg-gray-900/90 backdrop-blur-lg border-t-4 border-purple-200">
        <div class="max-w-xl mx-auto flex gap-4 sm:gap-6">
            <button onclick="handleBack()" class="flex-1 py-3 sm:py-4 bg-white dark:bg-gray-800 border-b-4 border-gray-300 rounded-3xl font-black text-lg sm:text-xl text-gray-600 active:translate-y-1 active:border-b-0 transition-all uppercase">Back</button>
            <button onclick="nextPage()" class="flex-1 py-3 sm:py-4 bg-purple-600 text-white border-b-4 border-purple-800 rounded-3xl font-black text-lg sm:text-xl shadow-xl active:translate-y-1 active:border-b-0 transition-all uppercase">Next üöÄ</button>
        </div>
    </footer>

    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 px-8 py-3 rounded-full text-white font-black shadow-2xl transition-all duration-300 opacity-0 pointer-events-none z-[60] text-lg sm:text-xl border-4 border-white"></div>

    <script>
        let currentView = 'home';
        let activeData = [];
        let currentPage = 0;
        let userAnswers = {};
        let fontSize = 22;
        let globalScore = 0;
        let isDarkMode = false;
        let isListening = false;
        let micUsedOnThisPage = false;
        let recognition = null;
        let currentActivityType = '';

        function adjustFont(val) {
            fontSize = Math.max(16, Math.min(42, fontSize + val));
            document.documentElement.style.setProperty('--user-font-size', fontSize + 'px');
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark', isDarkMode);
            document.getElementById('theme-icon').innerText = isDarkMode ? 'üåô' : '‚ú®';
        }

        function shuffle(array) {
            let cur = array.length, temp, rand;
            while (0 !== cur) {
                rand = Math.floor(Math.random() * cur); cur -= 1;
                temp = array[cur]; array[cur] = array[rand]; array[rand] = temp;
            }
            return array;
        }

        // Initialize Speech
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.onstart = () => { isListening = true; render(); };
            recognition.onend = () => { isListening = false; render(); };
            recognition.onresult = (e) => checkReading(e.results[0][0].transcript);
        }

        function goHome() {
            currentView = 'home';
            document.getElementById('quiz-footer').classList.add('hidden');
            document.getElementById('progress-container').classList.add('hidden');
            render();
            window.scrollTo(0, 0);
        }

        // Helper to flatten data for "One Question Each Time"
        function flattenData(source) {
            let flat = [];
            source.forEach(page => {
                page.qs.forEach(q => {
                    flat.push({
                        title: page.title,
                        instr: page.instr,
                        passage: page.passage || null,
                        qs: [q]
                    });
                });
            });
            return flat;
        }

        function startSection(type) {
            currentActivityType = type;
            micUsedOnThisPage = false;
            
            if (type === 'writing') {
                const wordsSource = (typeof spellingWords !== 'undefined') ? spellingWords : ["apple", "school", "pencil"];
                const shuffled = shuffle([...wordsSource]).slice(0, 50); 
                activeData = shuffled.map((w, i) => ({
                    title: `Spelling Word #${i+1}`,
                    instr: "Listen carefully and type the word!",
                    qs: [{ target: w, isWriting: true }]
                }));
            } else if (type === 'reading') {
                const sentsSource = (typeof readingSentences !== 'undefined') ? readingSentences : ["Reading is fun."];
                activeData = sentsSource.map((s, i) => ({
                    title: `Reading Mastery #${i+1}`,
                    instr: "Try to speak first, then you can listen!",
                    qs: [{ q: s, original: s, isReading: true }]
                }));
            } else {
                switch(type) {
                    case 'lesson': activeData = flattenData(lessonData); break;
                    case 'stories': activeData = flattenData(storiesData); break;
                    case 'wordparts': activeData = flattenData(wordPartsData); break;
                    case 'coin': activeData = flattenData([{ qs: shuffle([...initialCoinData]), title: "Coin Lab", instr: "Count the coins!" }]); break;
                    case 'time': activeData = flattenData([{ qs: generateTimeData(), title: "Time Lab", instr: "Read the clock!" }]); break;
                    case 'math': activeData = flattenData([{ qs: generateMathData(), title: "Math Lab", instr: "Solve the problem!" }]); break;
                    case 'shapes': activeData = flattenData([{ qs: generateShapesData(), title: "Shapes Lab", instr: "Identify the shape!" }]); break;
                    case 'grammar': activeData = flattenData([{ qs: generateGrammarData(), title: "Grammar Lab", instr: "Noun or Verb?" }]); break;
                }
            }
            
            currentPage = 0;
            userAnswers = {};
            currentView = 'quiz';
            render();
            window.scrollTo(0, 0);
        }

        function toggleMic() {
            if (!recognition) return;
            micUsedOnThisPage = true; 
            if (isListening) recognition.stop();
            else recognition.start();
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(text);
            msg.rate = 0.8;
            window.speechSynthesis.speak(msg);
        }

        function checkReading(heard) {
            const target = activeData[currentPage].qs[0].original.toLowerCase().replace(/[.,!?;:]/g, "");
            const words = heard.toLowerCase().split(" ");
            let match = 0;
            target.split(" ").forEach(w => { if(words.includes(w)) match++; });
            if (match / target.split(" ").length >= 0.6) handleAnswer(0, 0, true);
            else showToast("Try again! üé§", "#F44336");
        }

        function checkSpelling(qIdx) {
            const input = document.getElementById(`spell-input-${qIdx}`);
            const target = activeData[currentPage].qs[qIdx].target;
            if (input.value.trim().toLowerCase() === target.toLowerCase()) {
                handleAnswer(qIdx, 0, true);
            } else {
                showToast("Try again! Check the letters.", "#F44336");
                input.animate([{transform: 'translateX(0)'}, {transform: 'translateX(10px)'}, {transform: 'translateX(-10px)'}, {transform: 'translateX(0)'}], {duration: 200});
            }
        }

        function handleAnswer(qIdx, oIdx, isCorrect = null) {
            const key = `${currentPage}-${qIdx}`;
            if (userAnswers[key] !== undefined) return;
            const q = activeData[currentPage].qs[qIdx];
            const finalCorrect = isCorrect !== null ? isCorrect : (oIdx === q.c);
            userAnswers[key] = oIdx;
            if (finalCorrect) {
                globalScore++;
                showToast("BINGO! ‚≠ê", "#4CAF50");
            } else {
                showToast("OOPS! üçå", "#F44336");
            }
            render();
        }

        function showToast(msg, color) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.backgroundColor = color;
            t.style.opacity = "1";
            setTimeout(() => t.style.opacity = "0", 1500);
        }

        function render() {
            const main = document.getElementById('main-view');
            document.getElementById('score-val').innerText = globalScore;

            if (currentView === 'home') {
                main.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 sm:gap-8">
                    ${['lesson', 'stories', 'wordparts', 'reading', 'writing', 'coin', 'time', 'math', 'shapes', 'grammar'].map(type => `
                        <div onclick="startSection('${type}')" class="hub-card p-6 sm:p-10 text-white text-center shadow-xl ${type}-gradient">
                            <div class="text-4xl sm:text-6xl mb-2 sm:mb-4 drop-shadow-md">${getEmoji(type)}</div>
                            <h3 class="text-xl sm:text-2xl font-black uppercase tracking-tight font-['Comic_Neue']">${type === 'writing' ? 'Spelling' : type.replace('parts', ' parts')}</h3>
                            <p class="text-white/70 text-[10px] sm:text-sm font-bold mt-1 uppercase">10+ Pages</p>
                        </div>
                    `).join('')}
                </div>`;
            } else if (currentView === 'quiz') {
                document.getElementById('quiz-footer').classList.remove('hidden');
                document.getElementById('progress-container').classList.remove('hidden');
                const data = activeData[currentPage];
                const progress = ((currentPage + 1) / activeData.length) * 100;
                document.getElementById('progress-bar').style.width = progress + "%";

                if (currentActivityType === 'reading') {
                    const q = data.qs[0];
                    const answered = userAnswers[`${currentPage}-0`] !== undefined;
                    const canListen = micUsedOnThisPage || answered;
                    main.innerHTML = `<div class="text-center max-w-2xl mx-auto"><h2 class="text-2xl sm:text-3xl font-black mb-4 text-purple-600 uppercase font-['Comic_Neue']">${data.title}</h2><div class="instr-text mb-6">üí° ${data.instr}</div>
                        <div class="card p-6 sm:p-14 mb-8 flex flex-col items-center border-dashed"><div class="q-text mb-12 text-gray-800 leading-tight">"${q.q}"</div>
                            <div class="flex flex-col items-center gap-10">
                                <div class="relative flex items-center justify-center">${isListening ? '<div class="listening-ring"></div>' : ''}
                                    <button onclick="toggleMic()" class="w-24 h-24 sm:w-32 sm:h-32 rounded-full ${isListening ? 'bg-red-500 shadow-[0_0_30px_#ef4444]' : 'bg-purple-600 shadow-xl'} text-white flex items-center justify-center text-4xl sm:text-6xl z-10 transition-all ${answered ? 'opacity-30 pointer-events-none' : 'hover:scale-110'}">${isListening ? 'üõë' : 'üé§'}</button>
                                </div>
                                <button onclick="speak('${q.original}')" ${!canListen ? 'disabled' : ''} class="px-10 py-4 sm:px-14 sm:py-5 bg-blue-500 text-white rounded-3xl font-black text-xl sm:text-2xl shadow-xl transition-all ${!canListen ? 'opacity-30 grayscale pointer-events-none' : 'hover:bg-blue-600 active:translate-y-1'}">üîä Listen</button>
                                ${answered ? '<div class="text-6xl sm:text-8xl animate-bounce">‚úÖ‚≠ê</div>' : ''}
                            </div>
                        </div></div>`;
                } else if (currentActivityType === 'writing') {
                    let qsHtml = data.qs.map((q, qIdx) => {
                        const answered = userAnswers[`${currentPage}-${qIdx}`] !== undefined;
                        return `<div class="card p-6 sm:p-10 mb-6 flex flex-col items-center">
                            <button onclick="speak('${q.target}')" class="w-20 h-20 sm:w-24 sm:h-24 rounded-full bg-orange-500 text-white shadow-lg flex items-center justify-center text-4xl sm:text-5xl mb-6 hover:scale-110 active:scale-95 transition-all">üîä</button>
                            <input type="text" id="spell-input-${qIdx}" class="spelling-input text-2xl sm:text-3xl mb-4 ${answered ? 'bg-green-100 border-green-500 text-green-700 font-bold' : ''}" placeholder="Type here..." ${answered ? 'disabled value="'+q.target+'"' : ''} onkeydown="if(event.key==='Enter') checkSpelling(${qIdx})">
                            ${!answered ? `<button onclick="checkSpelling(${qIdx})" class="px-10 py-3 bg-green-500 text-white rounded-full font-black shadow-lg uppercase">Check</button>` : '<div class="text-2xl font-black text-green-600">‚ú® CORRECT ‚ú®</div>'}
                        </div>`;
                    }).join('');
                    main.innerHTML = `<div class="text-center max-w-2xl mx-auto"><h2 class="text-2xl sm:text-3xl font-black mb-4 text-orange-600 uppercase font-['Comic_Neue']">${data.title}</h2><div class="instr-text mb-6">üí° ${data.instr}</div>${qsHtml}</div>`;
                } else {
                    let passageHtml = data.passage ? `<div class="sticky-passage-wrapper"><div class="passage-box p-6 sm:p-8 shadow-xl mb-6 sm:mb-8 passage-text text-gray-700">${data.passage}</div></div>` : '';
                    let qsHtml = data.qs.map((q, qIdx) => {
                        const ans = userAnswers[`${currentPage}-${qIdx}`];
                        const answered = ans !== undefined;
                        return `<div class="card p-6 sm:p-10 mb-6 sm:mb-8 transform transition-all">
                            <div class="q-text mb-6 sm:mb-8 text-xl sm:text-3xl text-gray-800 leading-snug">${q.qText || q.q}</div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-5">
                                ${q.opts.map((opt, oIdx) => {
                                    let cls = answered ? (oIdx === q.c ? "correct" : (oIdx === ans ? "wrong" : "opacity-30")) : "hover:bg-purple-50";
                                    return `<button onclick="handleAnswer(${qIdx}, ${oIdx})" ${answered ? 'disabled' : ''} class="option-btn p-4 sm:p-5 font-black text-base sm:text-xl transition-all ${cls}">${opt}</button>`;
                                }).join('')}
                            </div>
                        </div>`;
                    }).join('');
                    main.innerHTML = `<div class="mb-10 text-center px-2"><h2 class="text-2xl sm:text-4xl font-black text-purple-700 uppercase tracking-tight font-['Comic_Neue']">${data.title}</h2><div class="inline-block px-4 py-1 bg-purple-100 text-purple-600 rounded-full font-bold text-xs sm:text-sm mt-1 instr-text">üí° ${data.instr}</div></div><div class="${data.passage ? 'lg:grid lg:grid-cols-2 lg:gap-14 items-start' : 'max-w-4xl mx-auto'}">${passageHtml}<div>${qsHtml}</div></div>`;
                }
            }
        }

        function getEmoji(type) {
            return { lesson:'üìñ', stories:'üìö', wordparts:'üß©', reading:'üéôÔ∏è', writing:'‚úèÔ∏è', coin:'üí∞', time:'‚è∞', math:'‚ûï', shapes:'üìê', grammar:'üñçÔ∏è' }[type] || '‚ú®';
        }

        function handleBack() { 
            micUsedOnThisPage = false; 
            currentPage > 0 ? (currentPage--, render(), window.scrollTo(0, 0)) : goHome(); 
        }
        function nextPage() { 
            micUsedOnThisPage = false; 
            currentPage < activeData.length - 1 ? (currentPage++, render(), window.scrollTo(0, 0)) : finish(); 
        }

        function finish() {
            currentView = 'results';
            document.getElementById('quiz-footer').classList.add('hidden');
            document.getElementById('progress-container').classList.add('hidden');
            document.getElementById('main-view').innerHTML = `<div class="text-center py-14 max-w-2xl mx-auto px-4"><div class="text-8xl sm:text-9xl mb-8 animate-bounce">üëë</div><h2 class="text-4xl sm:text-6xl font-black mb-4 text-purple-600 uppercase font-['Comic_Neue']">Victory!</h2><p class="text-xl sm:text-3xl font-bold text-gray-500 mb-10">You earned ${globalScore} stars!</p><button onclick="goHome()" class="px-12 py-5 sm:px-16 sm:py-8 bg-purple-600 text-white rounded-[3rem] font-black text-xl sm:text-3xl shadow-2xl hover:scale-110 active:scale-95 transition-all w-full sm:w-auto uppercase">Play Again üè†</button></div>`;
            window.scrollTo(0, 0);
        }

        window.onload = render;
    </script>
</body>
</html>

