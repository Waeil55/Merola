<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA & iOS App Meta Tags -->
    <title>Merola's Lab</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Merola's Lab">
    
    <!-- App Icons -->
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Waeil55/Merola/main/IMG_3813.png">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Waeil55/Merola/main/IMG_3813.png">
    <meta name="theme-color" content="#673AB7">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bubblegum+Sans&family=Comic+Neue:wght@700;900&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Data Imports (External Files) -->
    <script src="readingData.js"></script>
    <script src="lessonData.js"></script>
    <script src="quizGenerators.js"></script>
    <script src="wordPartsData.js"></script>
    <script src="storiesData.js"></script>
    <script src="writingData.js"></script>

    <style>
        :root {
            --bg-color: #F8F4FF;
            --card-bg: #ffffff;
            --text-color: #2D3436;
            --title-color: #9C27B0;
            --instr-color: #673AB7;
            --border-color: #B39DDB;
            --primary-action: #6C5CE7;
            --user-font-size: 22px;
            --header-bg: #673AB7;
            --passage-bg: #E1F5FE;
        }

        .dark {
            --bg-color: #1A1A2E;
            --card-bg: #2D3436;
            --text-color: #F3E5F5;
            --title-color: #BB86FC;
            --border-color: #5E35B1;
            --header-bg: #311B92;
            --passage-bg: #2C3E50;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Bubblegum Sans', cursive;
            background-image: radial-gradient(var(--border-color) 1px, transparent 1px);
            background-size: 30px 30px;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .q-text { 
            font-size: var(--user-font-size) !important; 
            font-family: 'Comic Neue', cursive; 
            font-weight: 900;
            color: var(--text-color) !important; 
        }

        .passage-text { 
            font-size: var(--user-font-size) !important; 
            line-height: 1.6; 
            font-weight: 900; 
            font-family: 'Comic Neue', cursive;
            color: var(--text-color) !important;
        }

        .instr-text { 
            font-size: calc(var(--user-font-size) * 0.7) !important; 
            line-height: 1.2; 
            font-weight: 800; 
            font-family: 'Comic Neue';
            color: var(--text-color);
            opacity: 0.9;
        }

        .option-btn { 
            font-size: calc(var(--user-font-size) * 0.9) !important; 
            border-radius: 20px; 
            background: var(--card-bg); 
            box-shadow: 0 5px 0 var(--border-color); 
            border: 2px solid var(--border-color); 
            color: var(--text-color); 
        }
        .option-btn:active { transform: translateY(3px); box-shadow: 0 2px 0 var(--border-color); }

        .card { 
            background-color: var(--card-bg); 
            border: 4px solid var(--border-color); 
            border-radius: 35px; 
            box-shadow: 6px 6px 0px var(--border-color); 
        }
        
        .passage-box { 
            background-color: var(--passage-bg) !important; 
            border: 4px dotted var(--primary-action) !important; 
            border-radius: 25px !important; 
        }

        .hub-card { 
            aspect-ratio: 1 / 1;
            border-radius: 22px; 
            cursor: pointer; 
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .hub-card:hover { transform: scale(1.05); }
        .hub-card:active { transform: scale(0.92); }
        
        .hub-card h3 {
            font-family: 'Comic Neue', cursive;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.6rem;
            margin-top: 4px;
            text-align: center;
            line-height: 1;
        }
        @media (min-width: 640px) {
            .hub-card h3 { font-size: 0.8rem; }
            .hub-card { border-radius: 28px; }
        }

        .section-header { display: flex; align-items: center; gap: 8px; margin-bottom: 0.8rem; }
        .section-icon { background: #E5E7EB; padding: 4px; border-radius: 8px; font-size: 1rem; color: #4B5563; }
        .section-title { font-family: 'Comic Neue', cursive; font-weight: 900; text-transform: uppercase; font-size: 1.1rem; color: #6B46C1; }

        .daily-mission-card {
            border-radius: 30px;
            background: linear-gradient(to bottom, #7E57C2, #5E35B1);
            padding: 1.2rem 1rem;
            text-align: center;
            color: white;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(94, 53, 177, 0.3);
            transition: transform 0.2s;
            max-width: 100%;
        }

        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.6); opacity: 0; } }
        .listening-ring { position: absolute; width: 100px; height: 100px; border-radius: 50%; border: 4px solid #ef4444; animation: pulse-ring 1.5s infinite; }

        .correct { background: #4CAF50 !important; color: white !important; border-color: #2E7D32 !important; box-shadow: 0 4px 0 #2E7D32 !important; }
        .wrong { background: #F44336 !important; color: white !important; border-color: #B71C1C !important; box-shadow: 0 4px 0 #B71C1C !important; }

        .glass-header { 
            background: linear-gradient(135deg, #673AB7 0%, #5E35B1 100%); 
            border-bottom: 3px solid #512DA8;
            border-radius: 0 0 25px 25px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            padding-top: max(1.1rem, env(safe-area-inset-top)); 
            padding-bottom: 0.4rem;
        }

        .app-footer {
            background: rgba(255, 255, 255, 0.98);
            border-top: 2px solid #D1C4E9;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
            transition: background 0.3s ease, border-color 0.3s ease;
            padding-bottom: max(0.4rem, env(safe-area-inset-bottom));
        }

        .dark .app-footer {
            background: #12122b !important;
            border-top: 2px solid #5E35B1;
        }

        .spelling-input {
            width: 100%; border: 3px solid var(--border-color); border-radius: 18px; padding: 12px;
            font-family: 'Comic Neue', cursive; font-weight: 700; outline: none; background: #fdfdfd; text-align: center;
            color: #2D3436; 
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="glass-header sticky top-0 z-50 px-4 text-white">
        <div class="flex justify-between items-center max-w-5xl mx-auto w-full">
            <div class="flex items-center gap-2">
                <!-- App Image Icon Logo -->
                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-white rounded-xl flex items-center justify-center overflow-hidden border border-white/20 shadow-inner">
                    <img src="https://raw.githubusercontent.com/Waeil55/Merola/main/IMG_3813.png" class="w-full h-full object-cover scale-110" alt="Merola Icon">
                </div>
                <div>
                    <h1 class="text-sm sm:text-base font-black font-['Comic_Neue'] tracking-tight leading-none uppercase">Merola's Lab</h1>
                    <p class="text-[6px] sm:text-[8px] uppercase font-bold text-yellow-300 leading-none mt-0.5 opacity-90">Grade 2 Discovery!</p>
                </div>
            </div>

            <div class="flex items-center gap-2 sm:gap-3">
                <!-- Font Adjustment Buttons with Increased Icon Size -->
                <div class="flex items-center bg-black/10 backdrop-blur rounded-full p-0.5 border border-white/10">
                    <button onclick="adjustFont(-2)" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/30 transition-colors">
                        <i data-lucide="minus" class="w-4.5 h-4.5 text-white"></i>
                    </button>
                    <button onclick="adjustFont(2)" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/30 transition-colors ml-0.5">
                        <i data-lucide="plus" class="w-4.5 h-4.5 text-white"></i>
                    </button>
                </div>

                <button onclick="toggleTheme()" class="w-8 h-8 sm:w-10 sm:h-10 bg-white/10 rounded-lg flex items-center justify-center border border-white/20">
                    <i data-lucide="sparkles" class="w-4.5 h-4.5"></i>
                </button>

                <div class="bg-yellow-400 text-purple-900 px-2 sm:px-3 py-0.5 rounded-full font-black border border-white shadow-sm">
                    ‚≠ê <span id="score-val" class="text-xs">0</span>
                </div>
                
                <button onclick="goHome()" class="w-8 h-8 sm:w-10 sm:h-10 bg-white/10 rounded-lg flex items-center justify-center border border-white/20">
                    <i data-lucide="home" class="w-4.5 h-4.5"></i>
                </button>
            </div>
        </div>
        
        <div id="progress-container" class="hidden max-w-5xl mx-auto w-full mt-1">
            <div class="h-1 bg-black/20 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-yellow-300 to-orange-400 transition-all duration-700"></div>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-5xl mx-auto px-4 py-3 sm:py-5 w-full">
        <div id="main-view"></div>
    </main>

    <footer id="quiz-footer" class="hidden sticky bottom-0 left-0 right-0 py-1.5 px-4 sm:px-6 z-40 app-footer backdrop-blur-lg">
        <div class="max-w-xl mx-auto flex gap-3 sm:gap-4">
            <button onclick="handleBack()" class="flex-1 py-1.5 bg-white dark:bg-gray-800 border-b-2 border-gray-300 dark:border-gray-900 rounded-xl font-black text-xs sm:text-sm text-gray-600 dark:text-gray-100 active:translate-y-0.5 transition-all uppercase">Back</button>
            <button id="next-btn" onclick="nextPage()" class="flex-1 py-1.5 bg-[#673AB7] text-white border-b-2 border-[#4527A0] rounded-xl font-black text-xs sm:text-sm shadow-md active:translate-y-0.5 transition-all uppercase">Next üöÄ</button>
        </div>
    </footer>

    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 px-5 py-1.5 rounded-full text-white font-black shadow-xl opacity-0 pointer-events-none z-[60] text-sm border-2 border-white transition-opacity duration-300"></div>

    <script>
        const lessonData = [
            // ANTONYMS (Sets 1-10)
            { title: "Antonyms: Set 1", instr: "Opposite Meanings", qs: [ { q: "A <u>problem</u>", opts: ["worry", "math", "solution", "sentence"], c: 2 }, { q: "Was <u>loose</u>", opts: ["tight", "large", "big", "win"], c: 0 }, { q: "A <u>question</u>", opts: ["word", "talk", "answer", "poem"], c: 2 }, { q: "Was <u>fact</u>", opts: ["true", "real", "scary", "fiction"], c: 3 }, { q: "Was <u>straight</u>", opts: ["bent", "tall", "narrow", "long"], c: 0 }, { q: "To <u>create</u>", opts: ["make", "build", "destroy", "draw"], c: 2 }, { q: "Was <u>shiny</u>", opts: ["bright", "dull", "pretty", "ugly"], c: 1 }, { q: "To <u>listen</u>", opts: ["hear", "ignore", "touch", "eat"], c: 1 }, { q: "Was <u>heavy</u>", opts: ["fat", "light", "hard", "solid"], c: 1 }, { q: "Is <u>safe</u>", opts: ["careful", "secure", "dangerous", "locked"], c: 2 } ] },
            { title: "Antonyms: Set 2", instr: "Choose the opposite", qs: [ { q: "Opposite of <u>rough</u>", opts: ["bumpy", "smooth", "hard", "tough"], c: 1 }, { q: "Opposite of <u>deep</u>", opts: ["shallow", "dark", "bottom", "blue"], c: 0 }, { q: "Opposite of <u>buy</u>", opts: ["sell", "get", "store", "shop"], c: 0 }, { q: "Opposite of <u>always</u>", opts: ["often", "never", "forever", "sometimes"], c: 1 }, { q: "Opposite of <u>early</u>", opts: ["soon", "late", "morning", "fast"], c: 1 }, { q: "Opposite of <u>tame</u>", opts: ["wild", "pet", "kind", "calm"], c: 0 }, { q: "Opposite of <u>brave</u>", opts: ["strong", "bold", "scared", "hero"], c: 2 }, { q: "Opposite of <u>push</u>", opts: ["shove", "pull", "move", "stop"], c: 1 }, { q: "Opposite of <u>cheap</u>", opts: ["expensive", "low", "free", "easy"], c: 0 }, { q: "Opposite of <u>clean</u>", opts: ["neat", "dirty", "fresh", "wash"], c: 1 } ] },
            { title: "Antonyms: Set 3", instr: "Choose the opposite", qs: [ { q: "Opposite of <u>young</u>", opts: ["baby", "old", "new", "small"], c: 1 }, { q: "Opposite of <u>sour</u>", opts: ["sweet", "tangy", "bitter", "lemon"], c: 0 }, { q: "Opposite of <u>full</u>", opts: ["whole", "empty", "half", "large"], c: 1 }, { q: "Opposite of <u>shout</u>", opts: ["whisper", "yell", "loud", "scream"], c: 0 }, { q: "Opposite of <u>top</u>", opts: ["high", "up", "bottom", "peak"], c: 2 }, { q: "Opposite of <u>friend</u>", opts: ["pal", "buddy", "enemy", "mate"], c: 2 }, { q: "Opposite of <u>start</u>", opts: ["begin", "go", "finish", "ready"], c: 2 }, { q: "Opposite of <u>asleep</u>", opts: ["dream", "awake", "nap", "tired"], c: 1 }, { q: "Opposite of <u>thick</u>", opts: ["fat", "heavy", "thin", "wide"], c: 2 }, { q: "Opposite of <u>smile</u>", opts: ["grin", "laugh", "frown", "happy"], c: 2 } ] },
            { title: "Antonyms: Set 10", instr: "Final Practice", qs: [ { q: "Opposite of <u>up</u>", opts: ["high", "down", "left", "top"], c: 1 }, { q: "Opposite of <u>cold</u>", opts: ["chilly", "ice", "hot", "snow"], c: 2 } ] }
        ];

        let currentView = 'home', activeData = [], currentPage = 0, userAnswers = {};
        let fontSize = 22, globalScore = 0, isDarkMode = false, isListening = false;
        let micUsedOnThisPage = false, recognition = null, currentActivityType = '';

        function adjustFont(val) {
            fontSize = Math.max(16, Math.min(42, fontSize + val));
            document.documentElement.style.setProperty('--user-font-size', fontSize + 'px');
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark', isDarkMode);
            lucide.createIcons();
        }

        function shuffle(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.onstart = () => { isListening = true; render(); };
            recognition.onend = () => { isListening = false; render(); };
            recognition.onresult = (e) => checkReading(e.results[0][0].transcript);
        }

        function goHome() {
            currentView = 'home';
            document.getElementById('quiz-footer').classList.add('hidden');
            document.getElementById('progress-container').classList.add('hidden');
            render();
            window.scrollTo(0, 0);
        }

        function flattenData(source) {
            if (!source || !Array.isArray(source)) return [];
            let flat = [];
            source.forEach(group => {
                if (group && group.qs && Array.isArray(group.qs)) {
                    group.qs.forEach(q => {
                        flat.push({ title: group.title, instr: group.instr, passage: group.passage || null, qs: [q] });
                    });
                }
            });
            return flat;
        }

        function startSection(type) {
            currentActivityType = type;
            micUsedOnThisPage = false;
            let dataToShuffle = [];

            if (type === 'writing') {
                const wordsSource = (typeof spellingWords !== 'undefined') ? spellingWords : ["apple"];
                dataToShuffle = shuffle([...wordsSource]).map(w => ({ title: `Spelling Word`, instr: "Type the word!", qs: [{ target: w, isWriting: true }] }));
            } else if (type === 'reading') {
                const sentsSource = (typeof readingSentences !== 'undefined') ? readingSentences : ["Hello"];
                dataToShuffle = shuffle([...sentsSource]).map(s => ({ title: `Reading Mastery`, instr: "Try to speak!", qs: [{ q: s, original: s, isReading: true }] }));
            } else {
                switch(type) {
                    case 'lesson': 
                        dataToShuffle = flattenData(typeof lessonData !== 'undefined' ? lessonData : []); 
                        break;
                    case 'stories': 
                        dataToShuffle = flattenData(typeof storiesData !== 'undefined' ? storiesData : []); 
                        break;
                    case 'wordparts': 
                        dataToShuffle = flattenData(typeof wordPartsData !== 'undefined' ? wordPartsData : []); 
                        break;
                    case 'coin': 
                        dataToShuffle = flattenData([{ qs: typeof initialCoinData !== 'undefined' ? initialCoinData : [], title: "Coin Lab", instr: "Count the coins!" }]); 
                        break;
                    case 'time': 
                        dataToShuffle = flattenData([{ qs: typeof generateTimeData === 'function' ? generateTimeData() : [], title: "Time Lab", instr: "Read the clock!" }]); 
                        break;
                    case 'math': 
                        dataToShuffle = flattenData([{ qs: typeof generateMathData === 'function' ? generateMathData() : [], title: "Math Lab", instr: "Solve the problem!" }]); 
                        break;
                    case 'shapes': 
                        dataToShuffle = flattenData([{ qs: typeof generateShapesData === 'function' ? generateShapesData() : [], title: "Shapes Lab", instr: "Identify shape!" }]); 
                        break;
                    case 'grammar': 
                        dataToShuffle = flattenData([{ qs: typeof generateGrammarData === 'function' ? generateGrammarData() : [], title: "Grammar Lab", instr: "Choose correctly!" }]); 
                        break;
                }
            }
            
            activeData = shuffle([...dataToShuffle]);
            currentPage = 0; userAnswers = {}; currentView = 'quiz';
            render();
            window.scrollTo(0, 0);
        }

        function toggleMic() {
            if (!recognition) return;
            micUsedOnThisPage = true; 
            if (isListening) recognition.stop(); else recognition.start();
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(text);
            msg.rate = 0.8;
            window.speechSynthesis.speak(msg);
        }

        function checkReading(heard) {
            const target = activeData[currentPage].qs[0].original.toLowerCase().replace(/[.,!?;:]/g, "");
            const words = heard.toLowerCase().split(" ");
            let match = 0;
            target.split(" ").forEach(w => { if(words.includes(w)) match++; });
            if (match / target.split(" ").length >= 0.6) handleAnswer(0, 0, true);
            else showToast("Try again! üé§", "#F44336");
        }

        function checkSpelling(qIdx) {
            const input = document.getElementById(`spell-input-${qIdx}`);
            const target = activeData[currentPage].qs[qIdx].target;
            if (input.value.trim().toLowerCase() === target.toLowerCase()) handleAnswer(qIdx, 0, true);
            else { showToast("Check spelling!", "#F44336"); }
        }

        function handleAnswer(qIdx, oIdx, isCorrect = null) {
            const key = `${currentPage}-${qIdx}`;
            if (userAnswers[key] !== undefined) return;
            const q = activeData[currentPage].qs[qIdx];
            const finalCorrect = isCorrect !== null ? isCorrect : (oIdx === q.c);
            userAnswers[key] = oIdx;
            if (finalCorrect) { globalScore++; showToast("BINGO! ‚≠ê", "#4CAF50"); } else { showToast("OOPS! üçå", "#F44336"); }
            render();
        }

        function showToast(msg, color) {
            const t = document.getElementById('toast'); t.innerText = msg; t.style.backgroundColor = color; t.style.opacity = "1";
            setTimeout(() => t.style.opacity = "0", 1500);
        }

        function renderHubItem(type, label, iconName, bgClass) {
            return `<div onclick="startSection('${type}')" class="hub-card ${bgClass} text-white">
                <i data-lucide="${iconName}" class="w-8 h-8 sm:w-10 sm:h-10 mb-1"></i>
                <h3>${label}</h3>
            </div>`;
        }

        function render() {
            const main = document.getElementById('main-view');
            document.getElementById('score-val').innerText = globalScore;

            if (currentView === 'home') {
                main.innerHTML = `<div class="space-y-6 max-w-5xl mx-auto">
                    <section>
                        <div class="section-header">
                            <div class="section-icon"><i data-lucide="book" class="w-4 h-4"></i></div>
                            <h2 class="section-title">Magic English</h2>
                        </div>
                        <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2.5 sm:gap-4">
                            ${renderHubItem('reading', 'Reading', 'mic', 'bg-[#D63384]')}
                            ${renderHubItem('writing', 'Spelling', 'pen-tool', 'bg-[#F9BC4D]')}
                            ${renderHubItem('stories', 'Stories', 'book-open', 'bg-[#3CC19C]')}
                            ${renderHubItem('wordparts', 'Word Lab', 'puzzle', 'bg-[#5B71EB]')}
                            ${renderHubItem('grammar', 'Grammar', 'pencil', 'bg-[#A6D934]')}
                        </div>
                    </section>
                    
                    <section>
                        <div class="section-header">
                            <div class="section-icon"><i data-lucide="award" class="w-4 h-4"></i></div>
                            <h2 class="section-title">Daily Mission</h2>
                        </div>
                        <div onclick="startSection('lesson')" class="daily-mission-card">
                            <i data-lucide="graduation-cap" class="w-10 h-10 mx-auto mb-2 text-white"></i>
                            <h3 class="font-['Comic_Neue'] font-black text-base uppercase tracking-widest">Lesson Mastery</h3>
                        </div>
                    </section>

                    <section>
                        <div class="section-header">
                            <div class="section-icon"><i data-lucide="binary" class="w-4 h-4"></i></div>
                            <h2 class="section-title" style="color: #E28C2B;">Math Quests</h2>
                        </div>
                        <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2.5 sm:gap-4">
                            ${renderHubItem('math', 'Math Lab', 'plus', 'bg-[#4396E8]')}
                            ${renderHubItem('time', 'Time Lab', 'clock', 'bg-[#EFD13B]')}
                            ${renderHubItem('coin', 'Coin Lab', 'coins', 'bg-[#48B365]')}
                            ${renderHubItem('shapes', 'Shapes', 'shapes', 'bg-[#C1369B]')}
                        </div>
                    </section>
                </div>`;
            } else if (currentView === 'quiz') {
                document.getElementById('quiz-footer').classList.remove('hidden');
                document.getElementById('progress-container').classList.remove('hidden');
                const data = activeData[currentPage], progress = ((currentPage + 1) / activeData.length) * 100;
                document.getElementById('progress-bar').style.width = progress + "%";

                const nextBtn = document.getElementById('next-btn');
                if (nextBtn) {
                    const isPageAnswered = data.qs.every((_, qIdx) => userAnswers[`${currentPage}-${qIdx}`] !== undefined);
                    nextBtn.disabled = !isPageAnswered;
                    nextBtn.style.opacity = isPageAnswered ? "1" : "0.3";
                    nextBtn.style.pointerEvents = isPageAnswered ? "auto" : "none";
                }

                if (currentActivityType === 'reading') {
                    const q = data.qs[0], answered = userAnswers[`${currentPage}-0`] !== undefined, canListen = micUsedOnThisPage || answered;
                    main.innerHTML = `<div class="text-center max-w-2xl mx-auto"><h2 class="text-lg font-black mb-1 text-purple-600 uppercase tracking-tight">${data.title}</h2><div class="instr-text mb-3">üí° ${data.instr}</div>
                        <div class="card p-5 sm:p-8 mb-4 flex flex-col items-center border-dashed"><div class="q-text mb-6 text-gray-800 leading-tight">"${q.q}"</div>
                            <div class="flex flex-col items-center gap-4">
                                <div class="relative flex items-center justify-center">${isListening ? '<div class="listening-ring"></div>' : ''}
                                    <button onclick="toggleMic()" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full ${isListening ? 'bg-red-500 shadow-lg' : 'bg-purple-600 shadow-md'} text-white flex items-center justify-center text-2xl z-10 transition-all ${answered ? 'opacity-30 pointer-events-none' : 'hover:scale-105'}"><i data-lucide="${isListening ? 'square' : 'mic'}" class="w-8 h-8"></i></button>
                                </div>
                                <button onclick="speak('${q.original}')" ${!canListen ? 'disabled' : ''} class="flex items-center gap-2 px-5 py-2 bg-blue-500 text-white rounded-xl font-black text-sm shadow-md transition-all ${!canListen ? 'opacity-30 grayscale pointer-events-none' : 'hover:bg-blue-600 active:translate-y-0.5'}"><i data-lucide="volume-2" class="w-4 h-4"></i> Listen</button>
                                ${answered ? '<div class="text-3xl animate-bounce mt-2 text-green-500 font-black">CORRECT!</div>' : ''}
                            </div>
                        </div></div>`;
                } else if (currentActivityType === 'writing') {
                    let qsHtml = data.qs.map((q, qIdx) => {
                        const answered = userAnswers[`${currentPage}-${qIdx}`] !== undefined;
                        return `<div class="card p-4 sm:p-6 mb-4 flex flex-col items-center">
                            <button onclick="speak('${q.target}')" class="w-12 h-12 sm:w-16 sm:h-16 rounded-full bg-orange-500 text-white shadow-md flex items-center justify-center mb-4 hover:scale-105 transition-all"><i data-lucide="volume-2" class="w-6 h-6"></i></button>
                            <input type="text" id="spell-input-${qIdx}" class="spelling-input text-lg sm:text-xl mb-4 ${answered ? 'bg-green-100 border-green-500 text-green-700 font-bold' : ''}" placeholder="Type here..." ${answered ? 'disabled value="'+q.target+'"' : ''} onkeydown="if(event.key==='Enter') checkSpelling(${qIdx})">
                            ${!answered ? `<button onclick="checkSpelling(${qIdx})" class="px-6 py-2 bg-green-500 text-white rounded-xl font-black shadow-sm uppercase text-sm">Check</button>` : '<div class="text-base font-black text-green-600">‚ú® CORRECT ‚ú®</div>'}
                        </div>`;
                    }).join('');
                    main.innerHTML = `<div class="text-center max-w-2xl mx-auto"><h2 class="text-lg font-black mb-1 text-orange-600 uppercase tracking-tight">${data.title}</h2><div class="instr-text mb-3">üí° ${data.instr}</div>${qsHtml}</div>`;
                } else {
                    let qsHtml = data.qs.map((q, qIdx) => {
                        const ans = userAnswers[`${currentPage}-${qIdx}`], answered = ans !== undefined;
                        return `<div class="card p-4 sm:p-6 mb-4 transform transition-all">
                            <div class="q-text mb-4 text-base leading-snug font-['Comic_Neue'] font-black">${q.qText || q.q}</div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                ${q.opts.map((opt, oIdx) => {
                                    let cls = answered ? (oIdx === q.c ? "correct" : (oIdx === ans ? "wrong" : "opacity-30")) : "hover:bg-purple-50";
                                    return `<button onclick="handleAnswer(${qIdx}, ${oIdx})" ${answered ? 'disabled' : ''} class="option-btn p-2.5 font-black text-sm transition-all ${cls}">${opt}</button>`;
                                }).join('')}
                            </div>
                        </div>`;
                    }).join('');
                    main.innerHTML = `<div class="mb-4 text-center px-2"><h2 class="text-lg font-black text-purple-700 uppercase tracking-tight font-['Comic_Neue']">${data.title}</h2><div class="inline-block px-2 py-0.5 bg-purple-100 text-purple-600 rounded-full font-bold text-[9px] mt-1 instr-text">üí° ${data.instr}</div></div><div class="max-w-4xl mx-auto">${data.passage ? `<div class="passage-box p-4 mb-4 passage-text">${data.passage}</div>` : ''}${qsHtml}</div>`;
                }
            } else if (currentView === 'results') {
                main.innerHTML = `<div class="text-center py-6 max-w-2xl mx-auto px-4"><div class="text-6xl mb-4 animate-bounce">üëë</div><h2 class="text-2xl sm:text-4xl font-black mb-2 text-purple-600 uppercase font-['Comic_Neue']">Victory!</h2><p class="text-base font-bold text-gray-500 mb-6">Finished with ${globalScore} stars!</p><button onclick="goHome()" class="px-8 py-3 bg-purple-600 text-white rounded-full font-black text-base shadow-lg hover:scale-105 transition-all w-full sm:w-auto uppercase">Play Again üè†</button></div>`;
            }
            lucide.createIcons();
        }

        function handleBack() { micUsedOnThisPage = false; currentPage > 0 ? (currentPage--, render(), window.scrollTo(0, 0)) : goHome(); }
        function nextPage() { micUsedOnThisPage = false; currentPage < activeData.length - 1 ? (currentPage++, render(), window.scrollTo(0, 0)) : finish(); }
        function finish() {
            currentView = 'results'; document.getElementById('quiz-footer').classList.add('hidden'); document.getElementById('progress-container').classList.add('hidden');
            render();
            window.scrollTo(0, 0);
        }
        window.onload = render;
    </script>
</body>
</html>

